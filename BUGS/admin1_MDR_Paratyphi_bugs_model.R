#### SETUP ####
rm(list = ls())
library(R2WinBUGS)
library(sp)
library(spdep)
library(rgdal)
library(coda)
library(data.table)
library(foreign)
library(tidyverse)
library(plyr)
library(ggplot2)
library(viridis)
RMSE = function(m, o){
  sqrt(mean((m - o)^2))
}

setwd("C:/Users/Annie/Documents/GRAM/typhi_paratyphi")
model_name <- 'MDR_Paratyphi/4_updated_data' 
dir.create(paste0('model_results/bugs/admin1/', model_name), showWarnings = F, recursive = T)

##Define the model in BUGS language ####
sink("typhi.bug")
cat("
MODEL 
{ 

    for(i in 1:S){
      h.2[i]~dnorm(0,tau.h2)
  }

  	for(i in 1:N){
      h.1[i]~dnorm(0,tau.h1)
  }
    for(i in 1:nTot){
      number_resistant[i] ~ dbin(p[i],sample_size[i])
    logit(p[i])<-beta0+b[1]*custom_stg1[i]+w.1[adj_id[i]]+h.1[adj_id[i]]+theta.1[year[i]]+h.2[source_num[i]]+nu.1[adj_id[i],year[i]]  
  }


#- Space
w.1[1:N]~car.normal(adj[],weights[],num[],tau.w)

for(k in 1:sumNumNeigh){
				weights[k]<-1
				}
				
# - Time- RW(1)
				
theta.1[1:T] ~ car.normal(adj.t[], weights.t[], num.t[], tau.t)

             for(t in 1:1) {
                weights.t[t] <- 1;
               adj.t[t] <- t+1;
               num.t[t] <- 1
             }
             for(t in 2:(T-1)) {
                weights.t[2+(t-2)*2] <- 1;
              adj.t[2+(t-2)*2] <- t-1
                weights.t[3+(t-2)*2] <- 1;
               adj.t[3+(t-2)*2] <- t+1;
              num.t[t] <- 2
            }
             for(t in T:T) {
                weights.t[(T-2)*2 + 2] <- 1;
               adj.t[(T-2)*2 + 2] <- t-1;
               num.t[t] <- 1
             }

# Space-time Type I interaction
for( i in 1 : N ) {
for( t in 1 : T ) {
nu.1[i,t]~dnorm(0, tau.nu)
}
}

#Hyper priors

# tau.h1~dgamma(0.5,0.0005)
tau.h1 <- pow(sigma.h1,-2)
sigma.h1 ~ dnorm(0,1)I(0,)

# tau.h2~dgamma(0.5,0.0005)
tau.h2 <- pow(sigma.h2,-2)
sigma.h2 ~ dnorm(0,1)I(0,)

# tau.t ~ dgamma(0.5,0.0005)
tau.t <- pow(sigma.t,-2)
sigma.t ~ dnorm(0,1)I(0,)

# tau.w ~ dgamma(0.5, 0.0005)
tau.w <- pow(sigma.w,-2)
sigma.w ~ dnorm(0,1)I(0,)

# tau.nu ~ dgamma(0.5,0.0005)
tau.nu <- pow(sigma.nu,-2)
sigma.nu ~ dnorm(0,1)I(0,)

#Intercepts
beta0~dflat()

#Coefficients

for(i in 1:1){ 
b[i]~dnorm(0,0.1) 
}

}
# end model
", fill=TRUE)
sink()

# Setup the data ####
#get the input data
mydata <- fread("model_prep/clean_data/outliered/MDR_Paratyphi_outliered.csv")
mydata <- mydata[mydata$is_outlier == 0,]
mydata <- mydata[,.(adj_id, country, year = year_id, source_id =nid, 
                    number_resistant, sample_size, val)]


#get covs (to have a template for all country-years)
covs <- read.csv("model_results/stacked_ensemble/MDR_Paratyphi/2021_06_25/custom_stage1_df.csv")

all_covs <- read.csv("covariates/all_admin1_typhi_covs.csv")

covs <- merge(covs, unique(all_covs[c('adj_id', 'COUNTRY_ID')]))

rm(all_covs)

covs <- covs[order(covs$year_id, covs$adj_id),]
names(covs)[2] <- 'year'
#add the covariates onto the data
mydata <- merge(covs, mydata)

#add the covs data frame onto the data for predictions
# This will mean the data for fitting is on top and prediction on the bottom
mydata <- rbind.fill(mydata, covs)

#Make year id 1:30
mydata$year <- mydata$year-1989

#fill in the missing values (made it work with the aggregated file)
mydata$source_id <- as.numeric(as.factor(mydata$source_id))
mydata$source_id[is.na(mydata$source_id)] <- max(mydata$source_id,na.rm=T)+1
mydata$sample_size[is.na(mydata$sample_size)] <- 50

#restrict to South southeast east Asia and Oceania, also remove mauritus
mydata <- mydata[mydata$adj_id<=904,]
mydata <- mydata[!(mydata$adj_id>=398 & mydata$adj_id<=820),]
mydata <- mydata[mydata$COUNTRY_ID!='MUS',]
#set up adjacency matrix info ####

num <- c(0,3,4,6,2,5,3,6,4,8,5,0,7,2,6,6,6,4,6,6,6,8,3,4,8,4,2,4,7,0,2,7,26,14,6,0,0,3,1,1,1,0,0,1,2,
         0,2,4,2,1,3,1,4,3,2,0,2,3,2,1,4,3,4,4,4,2,4,6,3,3,4,2,3,3,3,3,5,7,7,5,6,7,6,8,5,1,5,2,6,6,3,
         1,7,6,7,6,6,7,3,5,0,0,5,5,8,6,5,5,8,4,6,4,6,8,10,6,4,6,5,5,5,4,5,4,5,4,4,3,0,6,7,4,6,3,5,5,7,
         3,8,6,6,8,6,7,3,6,0,0,3,4,4,5,4,5,4,2,3,3,5,4,1,2,4,6,7,3,2,2,7,4,2,0,0,0,2,2,3,3,2,2,2,4,3,
         2,1,5,3,3,4,3,0,0,4,7,6,5,5,4,3,0,0,4,0,4,5,0,0,1,4,4,2,0,6,4,7,3,5,3,3,5,4,7,4,0,0,1,0,0,0,
         0,1,0,0,4,4,6,7,8,4,4,7,7,6,3,4,6,5,8,9,4,7,3,9,8,5,5,7,5,7,6,8,8,5,4,4,3,6,4,6,3,4,3,4,5,7,
         4,4,7,7,5,0,3,4,6,2,6,7,5,2,4,3,5,4,6,5,7,6,7,5,5,10,5,4,7,6,5,5,5,5,0,6,5,3,5,3,3,4,2,4,5,3,
         1,3,0,0,0,2,6,7,6,5,4,5,5,5,6,5,7,5,3,7,6,3,4,7,4,7,3,4,6,5,4,4,5,3,6,5,4,4,7,3,2,3,5,6,5,3,
         6,7,6,4,5,5,6,4,5,6,4,4,6,8,4,8,6,6,4,6,4,6,6,0,0,0,0,0,0,0,2,2,1,3,7,11,0,5,6,4,3,5,9,3,7,5,
         3,6,3,8,8,6,5,5,6,5,6,4,3,4,4,4,5,6,6,7,4,6,4,5,5,4,6,6,4,3,6,6,7,5,5,8,5,2,3,7,5,4,7,10,2,5,
         5,3,3,3,6,7,5,6,6,4,7,4,5,4,8,8,7,4,6,6,7,4,5,4,6,6,6,4,7,5,4,7,7,5,4,6,7,5,6,4,8,3,7,4,6,3,4,
         13,6,7,2,5,2,11,4,5,5,6,10,6,6,5,4,4,4,4,1,2,3,6,4,4,4,6,4,4,3,9,6,4,6,8,4,6,5,7,5,5,7,6,5,6,6,
         5,9,4,7,3,3,6,4,10,6,6,5,6,7,3,6,5,5,5,6,3,5,6,7,7,7,3,7,3,5,6,3,6,5,5,4,10,5,3,4,4,4,2,3,6,1,
         4,3,4,4,10,4,3,3,8,3,6,6,4,6,2,3,8,8,2,5,4,4,6,3,6,4,3,4,4,4,3,6,3,5,5,2,5,3,9,6,5,4,2,3,2,3,3,
         5,4,3,5,2,4,4,6,2,13,6,8,4,5,5,6,8,3,8,3,2,4,1,7,8,5,6,4,5,2,5,4,5,3,4,4,6,4,4,7,3,1,8,5,5,6,7,
         9,4,4,6,4,3,4,3,5,5,6,5,6,5,6,5,4,6,2,5,3,4,6,7,5,6,4,3,7,6,5,7,7,5,4,7,6,3,3,4,5,3,5,5,5,6,5,
         7,5,6,3,6,7,6,8,3,5,9,9,6,7,5,4,5,6,5,3,4,3,3,7,5,3,4,5,6,2,5,3,5,4,9,7,6,6,6,4,6,5,6,4,4,4,4,
         5,7,5,3,6,8,4,5,4,3,4,6,2,8,3,4,4,2,8,6,6,2,4,5,4,7,5,5,5,5,6,7,4,4,2,6,6,4,5,5,6,7,5,4,4,4,7,
         4,3,3,6,5,8,7,5,5,4,3,9,6,0,6,13,2,2,6,6,10,5,3,0,7,5,4,5,4,4,6,7,4,5,4,11,7,7,5,6,3,5,4,4,6,9,
         7,5,6,2,6,2,1,5,5,3,12,5,4,5,4,4,5,9,8,2,8,10,4,5,7)

sumNumNeigh<-sum(num)

#specify data and adjacency matrix ####
bugs.data <- list(N=904,T=30,nTot=length(mydata$number_resistant), S=max(mydata$source_id),
                  number_resistant=round(mydata$number_resistant,0),sample_size=mydata$sample_size,
                  adj_id = mydata$adj_id, year = mydata$year, source_num = mydata$source_id,
                  custom_stg1 = mydata$cv_custom_stage_1,
                  num=num,sumNumNeigh=sumNumNeigh,
                  adj=c(
                    
                    32,33,870,
                    33,854,870,891,
                    15,16,18,19,26,35,
                    13,31,
                    11,16,17,25,29,
                    9,19,35,
                    22,23,24,25,29,32,
                    7,10,17,19,
                    9,11,17,34,350,357,376,389,
                    6,10,17,29,34,
                    
                    5,15,21,22,26,28,31,
                    20,22,
                    4,13,16,25,26,28,
                    4,6,15,17,19,25,
                    6,9,10,11,16,19,
                    4,26,27,35,
                    4,7,9,16,17,35,
                    14,21,22,213,216,223,
                    13,20,22,35,213,218,
                    8,13,14,20,21,23,25,28,
                    8,22,25,
                    8,29,32,33,
                    6,8,15,16,22,23,28,29,
                    4,13,15,18,
                    18,35,
                    13,15,22,25,
                    6,8,11,24,25,33,34,
                    
                    5,13,
                    2,8,24,33,431,870,904,
                    2,3,24,29,32,34,133,827,830,831,832,834,838,840,841,845,854,866,870,880,891,892,893,894,895,896,
                    10,11,29,33,110,111,112,130,133,144,334,351,353,389,
                    4,7,18,19,21,27,
                    
                    
                    39,40,41,
                    38,
                    38,
                    38,
                    
                    
                    67,
                    58,75,
                    
                    55,58,
                    66,67,68,76,
                    70,71,
                    67,
                    53,62,63,
                    62,
                    51,63,65,74,
                    65,69,74,
                    47,71,
                    
                    61,69,
                    45,47,60,
                    61,72,
                    58,
                    57,59,67,69,
                    51,52,63,
                    51,53,62,65,
                    72,314,315,322,
                    53,54,63,74,
                    48,68,
                    44,48,50,61,
                    48,66,73,76,168,169,
                    54,57,61,
                    49,71,73,
                    49,55,70,73,
                    59,64,
                    68,70,71,
                    53,54,65,
                    45,199,209,
                    48,68,169,
                    78,90,97,237,287,
                    77,91,95,97,241,287,302,
                    80,82,84,87,94,338,381,
                    79,81,82,84,95,
                    80,83,84,85,95,100,
                    79,80,87,93,95,97,98,
                    81,85,86,88,100,369,
                    79,80,81,92,94,100,333,360,
                    81,83,88,95,302,
                    83,
                    79,82,89,98,381,
                    83,85,
                    87,96,98,345,381,382,
                    77,93,97,237,294,300,
                    78,241,302,
                    84,
                    82,90,97,98,106,294,304,
                    79,84,99,338,360,365,
                    78,80,81,82,85,97,302,
                    89,98,103,342,345,377,
                    77,78,82,90,93,95,
                    82,87,89,93,96,103,106,
                    94,338,365,
                    81,83,84,333,369,
                    
                    
                    96,98,106,116,342,
                    110,111,115,144,243,
                    108,117,118,119,260,267,331,371,
                    93,98,103,113,116,304,
                    109,119,331,364,383,
                    105,114,260,371,386,
                    107,111,112,115,118,119,334,383,
                    34,104,111,144,
                    34,104,109,110,112,115,
                    34,109,111,334,
                    106,114,116,304,344,373,
                    108,113,234,257,260,304,344,386,
                    104,109,111,118,243,253,264,274,278,307,
                    103,106,113,342,366,373,
                    105,118,253,267,
                    105,109,115,117,119,253,
                    105,107,109,118,331,
                    121,122,123,125,127,
                    120,122,124,126,127,
                    120,121,123,124,
                    120,122,124,125,128,
                    121,122,123,867,
                    120,123,126,127,128,
                    121,125,127,128,
                    120,121,125,126,
                    123,125,126,
                    
                    34,133,137,142,143,144,
                    132,245,248,276,282,283,284,
                    131,139,146,248,
                    33,34,130,142,880,881,
                    136,145,146,
                    136,140,141,145,822,
                    134,135,140,145,146,
                    130,138,139,143,144,242,255,
                    137,139,255,
                    132,137,138,143,146,248,255,301,
                    135,136,141,142,143,146,
                    135,140,142,822,859,861,
                    130,133,140,141,143,859,862,881,
                    130,137,139,140,142,146,
                    34,104,110,130,137,242,243,
                    134,135,136,
                    132,134,136,139,140,143,
                    
                    
                    154,155,157,
                    151,152,153,156,
                    150,152,154,157,
                    150,151,153,154,155,
                    150,152,155,156,
                    149,151,152,155,157,
                    149,152,153,154,
                    150,153,
                    149,151,154,
                    162,163,164,
                    165,166,167,296,308,
                    164,165,171,265,
                    170,
                    158,163,
                    158,162,164,170,
                    158,160,163,165,170,171,
                    159,160,164,167,170,265,308,
                    159,293,296,
                    159,165,
                    68,169,
                    68,76,168,398,399,400,401,
                    161,163,164,165,
                    160,164,
                    
                    
                    
                    177,178,
                    189,190,
                    175,178,189,
                    175,177,189,
                    182,190,
                    181,182,
                    180,182,
                    179,180,181,183,
                    182,186,187,
                    186,188,
                    186,
                    183,184,185,187,188,
                    183,186,188,
                    184,186,187,
                    176,177,178,190,
                    176,179,189,
                    
                    
                    194,195,209,210,
                    193,196,199,204,205,209,210,
                    193,196,197,202,204,210,
                    194,195,202,204,205,
                    195,198,202,205,211,
                    197,205,208,211,
                    75,194,209,
                    
                    
                    195,196,197,205,
                    
                    194,195,196,210,
                    194,196,197,198,202,
                    
                    
                    198,
                    75,193,194,199,
                    193,194,195,204,
                    197,198,
                    
                    20,21,218,220,222,223,
                    215,217,221,410,
                    214,217,220,222,402,410,413,
                    20,220,223,
                    214,215,219,221,222,
                    21,213,222,
                    217,221,222,
                    213,215,216,222,223,
                    214,217,219,222,
                    213,215,217,218,219,220,221,
                    20,213,216,220,
                    
                    
                    231,
                    
                    
                    
                    
                    226,
                    
                    
                    114,257,304,309,
                    254,279,295,298,
                    238,259,268,269,289,290,
                    77,90,249,256,261,287,300,
                    236,241,244,258,269,271,287,289,
                    262,295,298,306,
                    249,254,261,275,
                    78,91,238,244,285,287,302,
                    137,144,243,251,252,255,301,
                    104,115,144,242,251,274,
                    238,241,285,
                    131,282,283,299,
                    249,256,257,286,288,305,
                    262,277,278,297,301,
                    131,132,139,259,284,298,301,306,
                    237,240,246,253,256,261,266,275,305,
                    263,272,299,303,
                    242,243,252,274,280,297,301,
                    242,251,301,
                    115,117,118,249,266,267,275,278,305,
                    235,240,261,262,275,279,292,295,
                    137,138,139,242,301,
                    237,246,249,286,300,
                    114,234,246,260,286,288,309,
                    238,261,269,271,292,
                    236,248,268,279,284,290,298,
                    105,108,114,257,267,288,
                    237,240,249,254,258,271,287,292,
                    239,247,254,275,277,295,301,306,
                    250,273,296,299,303,
                    115,274,280,307,
                    160,165,270,308,
                    249,253,305,
                    105,117,253,260,288,305,
                    236,259,269,279,
                    236,238,258,268,279,292,
                    265,296,308,
                    238,258,261,287,
                    250,283,299,
                    263,293,296,303,
                    115,243,251,264,280,
                    240,249,253,254,262,277,278,
                    131,282,284,291,
                    247,262,275,278,
                    115,247,253,275,277,297,307,
                    235,254,259,268,269,292,298,
                    251,264,274,297,307,
                    
                    131,245,276,
                    131,245,272,299,
                    131,248,259,276,290,291,
                    241,244,
                    246,256,257,294,300,309,
                    77,78,237,238,241,261,271,
                    246,257,260,267,305,
                    236,238,
                    236,259,284,291,
                    276,284,290,
                    254,258,261,269,279,
                    166,273,296,303,
                    90,93,286,300,304,309,
                    235,239,254,262,298,
                    159,166,263,270,273,293,308,
                    247,251,278,280,301,307,
                    235,239,248,259,279,295,306,
                    245,250,263,272,283,
                    90,237,256,286,294,
                    139,242,247,248,251,252,255,262,297,306,
                    78,85,91,95,241,
                    250,263,273,293,
                    93,106,113,114,234,294,309,
                    246,249,253,266,267,288,
                    239,248,262,298,301,
                    115,264,278,280,297,
                    159,165,265,270,296,
                    234,257,286,294,304,
                    
                    312,316,317,319,320,321,
                    311,314,315,317,321,
                    318,320,323,
                    64,312,315,317,319,
                    64,312,314,
                    311,319,320,
                    311,312,314,319,
                    313,323,
                    311,314,316,317,
                    311,313,316,321,323,
                    311,312,320,
                    64,
                    313,318,320,
                    
                    
                    
                    366,373,
                    338,352,355,365,372,374,
                    336,337,357,359,384,385,389,
                    336,350,368,370,376,379,
                    105,107,119,364,371,
                    346,354,362,369,
                    84,100,335,360,369,
                    34,109,112,351,383,
                    333,347,354,360,369,
                    329,330,337,350,359,368,
                    329,336,356,368,384,
                    79,94,99,328,352,365,381,
                    340,363,370,380,390,
                    339,378,380,
                    343,345,349,358,374,381,382,
                    96,103,116,366,375,377,
                    341,349,358,
                    113,114,373,386,
                    89,96,341,358,377,382,388,
                    332,347,348,354,
                    335,346,348,354,360,361,372,
                    346,347,361,
                    341,343,355,374,
                    10,330,336,357,359,376,
                    34,334,353,383,385,
                    328,338,374,381,
                    34,351,385,389,
                    332,335,346,347,369,
                    328,349,374,
                    337,368,380,384,387,390,
                    10,329,350,359,389,
                    341,343,345,388,
                    329,336,350,357,
                    84,94,333,335,347,365,372,
                    347,348,372,
                    332,369,
                    339,370,376,
                    107,331,378,383,387,
                    94,99,328,338,360,372,
                    116,327,342,373,375,
                    375,377,388,
                    330,336,337,356,379,390,
                    83,100,332,333,335,354,362,
                    330,339,363,376,379,390,
                    105,108,331,386,
                    328,347,360,361,365,
                    113,116,327,344,366,
                    328,341,349,352,355,381,
                    342,366,367,377,
                    10,330,350,363,370,
                    96,342,345,367,375,388,
                    340,364,380,387,
                    330,368,370,390,
                    339,340,356,378,387,390,
                    79,87,89,338,341,352,374,382,
                    89,341,345,381,
                    107,109,334,351,364,384,385,387,
                    329,337,356,383,385,387,
                    329,351,353,383,384,389,
                    108,114,344,371,
                    356,364,378,380,383,384,
                    345,358,367,377,
                    10,34,329,353,357,385,
                    339,356,368,370,379,380,
                    
                    
                    
                    
                    
                    
                    
                    169,401,
                    169,401,
                    169,
                    169,398,399,
                    215,403,406,409,411,413,415,
                    402,405,406,407,408,409,410,411,412,414,415,
                    
                    403,406,407,410,412,
                    402,403,405,411,412,415,
                    403,405,412,415,
                    403,409,410,
                    402,403,408,410,414,
                    214,215,403,405,408,409,412,413,414,
                    402,403,406,
                    403,405,406,407,410,413,415,
                    215,402,410,412,415,
                    403,409,410,
                    402,403,406,407,412,413,
                    440,444,898,
                    418,423,425,426,435,439,441,446,
                    417,421,422,423,424,441,448,449,
                    430,432,437,444,445,898,
                    423,428,438,446,449,
                    418,424,429,434,441,
                    418,424,432,433,436,448,
                    417,418,420,446,449,
                    418,421,422,427,433,434,
                    417,426,435,541,
                    417,425,439,
                    424,431,433,434,
                    420,438,446,897,
                    421,434,441,443,
                    419,432,444,448,449,
                    32,427,433,447,900,904,
                    419,422,430,436,445,448,
                    422,424,427,431,436,445,447,
                    421,424,427,429,
                    417,425,442,446,541,552,
                    422,432,433,445,
                    419,445,447,898,900,
                    420,428,440,449,897,
                    417,426,441,443,
                    416,438,444,449,897,898,
                    417,418,421,429,439,443,
                    435,446,552,897,
                    429,439,441,
                    416,419,430,440,449,898,
                    419,432,433,436,437,447,
                    417,420,423,428,435,442,897,
                    431,433,437,445,900,
                    418,422,430,432,449,
                    418,420,423,430,438,440,444,448,
                    454,455,457,638,655,
                    453,457,
                    453,457,637,
                    451,452,456,457,637,641,643,
                    450,455,456,457,637,
                    450,454,456,637,
                    453,454,455,457,458,637,641,
                    450,451,452,453,454,456,458,637,638,643,
                    456,457,
                    465,475,478,499,501,
                    468,472,485,503,504,
                    490,496,506,
                    468,471,503,
                    477,479,497,
                    467,482,486,488,492,495,
                    459,475,489,501,630,632,633,
                    469,470,481,495,505,
                    464,474,476,482,488,491,
                    460,462,470,471,485,503,
                    466,470,488,495,
                    466,468,469,471,485,488,505,
                    462,468,470,505,
                    460,487,493,503,504,
                    479,486,492,497,
                    467,478,483,485,488,491,502,504,
                    459,465,478,483,489,494,496,502,
                    467,482,491,500,707,718,719,
                    463,479,498,704,
                    459,474,475,483,491,499,
                    463,473,477,492,497,498,
                    491,499,610,611,615,618,718,
                    466,486,495,497,
                    464,467,476,492,500,
                    474,475,478,502,
                    487,490,493,494,496,502,
                    460,468,470,474,488,504,
                    464,473,481,492,495,497,
                    472,484,490,493,
                    464,467,469,470,474,485,495,
                    465,475,496,506,632,
                    461,484,487,496,
                    467,474,476,478,480,499,718,
                    464,473,479,482,486,498,500,
                    472,484,487,502,504,
                    475,484,496,502,
                    464,466,469,481,486,488,
                    461,475,484,489,490,494,506,
                    463,473,479,481,486,
                    477,479,492,500,704,708,
                    459,478,480,491,
                    476,482,492,498,703,706,708,719,
                    459,465,633,
                    474,475,483,484,493,494,504,
                    460,462,468,472,
                    460,472,474,485,493,502,
                    466,470,471,
                    461,489,496,632,
                    513,515,520,522,523,524,530,532,670,672,678,679,680,
                    511,512,513,514,528,529,
                    511,517,519,521,525,526,528,
                    513,524,
                    508,509,514,517,528,
                    508,529,
                    507,508,510,514,515,516,517,518,520,524,529,
                    508,511,513,517,
                    507,513,518,523,524,
                    513,517,519,520,521,
                    509,511,513,514,516,521,
                    513,515,522,523,529,530,532,603,609,670,
                    509,516,520,521,525,531,
                    507,513,516,519,527,531,
                    509,516,517,519,525,
                    507,518,530,670,
                    507,515,518,532,
                    507,510,513,515,
                    509,519,521,531,
                    509,
                    520,531,
                    508,509,511,
                    508,512,513,518,603,625,
                    507,518,522,532,
                    519,520,525,527,
                    507,518,523,530,
                    540,543,547,548,572,577,
                    538,542,545,546,
                    537,545,546,548,
                    554,556,557,
                    535,538,541,546,548,549,551,555,560,
                    534,537,542,544,546,555,
                    550,556,557,559,
                    533,547,548,549,556,559,
                    425,435,537,544,551,552,555,558,
                    534,538,544,552,
                    533,545,548,572,574,578,
                    538,541,542,552,555,
                    534,535,543,546,548,562,574,
                    534,535,537,538,545,
                    533,540,554,556,577,
                    533,535,537,540,543,545,549,
                    537,540,548,553,559,560,
                    539,551,553,558,559,
                    537,541,550,553,558,560,
                    435,442,541,542,544,897,
                    549,550,551,559,560,
                    536,547,556,566,577,725,756,759,798,
                    537,538,541,544,
                    536,539,540,547,554,557,559,
                    536,539,556,
                    541,550,551,
                    539,540,549,550,553,556,
                    537,549,551,553,
                    565,568,569,573,575,576,589,662,690,693,
                    545,563,570,574,594,655,
                    562,564,565,570,655,662,
                    563,565,568,570,578,
                    561,563,564,568,573,662,
                    554,567,571,575,576,577,756,
                    566,576,577,
                    561,564,565,569,573,578,
                    561,568,572,576,578,
                    562,563,564,574,578,
                    566,575,692,756,791,
                    533,543,569,576,577,578,
                    561,565,568,
                    543,545,562,570,578,
                    561,566,571,576,690,692,
                    561,566,567,569,572,575,577,
                    533,547,554,566,567,572,576,
                    543,564,568,569,570,572,574,
                    580,585,586,
                    579,583,585,586,588,590,591,
                    584,587,657,
                    583,584,587,588,591,
                    580,582,587,588,590,657,
                    581,582,587,
                    579,580,586,589,684,689,
                    579,580,585,589,590,
                    581,582,583,584,657,
                    580,582,583,591,
                    561,585,586,590,657,662,686,688,689,693,
                    580,583,586,589,657,
                    580,582,588,
                    593,594,595,596,
                    592,594,596,655,
                    562,592,593,655,
                    592,596,
                    592,593,595,
                    599,600,601,602,688,693,
                    601,
                    597,601,693,697,
                    597,601,602,
                    597,598,599,600,
                    597,600,684,688,
                    518,529,605,606,607,609,613,614,622,625,
                    612,616,623,624,
                    603,606,613,
                    603,605,614,
                    603,609,610,616,618,620,621,622,
                    623,624,627,
                    518,603,607,618,670,671,
                    480,607,611,615,616,620,
                    480,610,618,620,
                    604,615,616,619,624,626,
                    603,605,
                    603,606,625,
                    480,610,612,616,619,626,712,718,
                    604,607,610,612,615,621,623,626,
                    621,627,
                    480,607,609,611,620,
                    612,615,626,712,
                    607,610,611,618,
                    607,616,617,622,623,627,
                    603,607,621,
                    604,608,616,621,624,627,
                    604,608,612,623,
                    529,603,614,
                    612,615,616,619,
                    608,617,621,623,
                    630,631,633,634,
                    630,631,632,
                    465,628,629,631,632,633,
                    628,629,630,
                    465,489,506,629,630,
                    465,501,628,630,634,
                    628,633,
                    636,637,638,639,642,
                    635,639,642,
                    452,453,454,455,456,457,635,638,642,
                    450,457,635,637,639,655,
                    635,636,638,640,655,
                    639,655,808,812,
                    453,456,
                    635,636,637,
                    453,457,
                    648,649,652,
                    646,647,650,
                    645,647,649,651,652,
                    645,646,650,652,
                    644,649,651,
                    644,646,648,651,652,
                    645,647,
                    646,648,649,655,
                    644,646,647,649,
                    654,658,660,661,664,817,
                    653,660,
                    450,562,563,593,594,638,639,640,651,661,662,664,812,
                    657,659,662,663,664,665,
                    581,583,587,589,590,656,662,665,
                    653,660,813,817,
                    656,660,663,664,665,
                    653,654,658,659,664,
                    653,655,664,807,812,817,
                    561,563,565,589,655,656,657,664,
                    656,659,664,
                    653,655,656,659,660,661,662,663,
                    656,657,659,
                    674,677,
                    669,673,676,683,
                    673,
                    667,670,672,676,681,682,683,
                    507,518,522,609,669,671,672,682,
                    609,670,674,675,682,
                    507,669,670,678,680,681,
                    667,668,676,683,
                    666,671,675,677,682,
                    671,674,
                    667,669,673,677,682,
                    666,674,676,682,
                    507,672,679,680,681,
                    507,678,680,
                    507,672,678,679,
                    669,672,678,683,
                    669,670,671,674,676,677,
                    667,669,673,681,
                    585,602,688,689,
                    691,694,696,753,757,769,788,
                    589,688,689,
                    688,
                    589,597,602,684,686,687,689,693,
                    585,589,684,686,688,
                    561,575,692,693,696,
                    685,693,694,695,696,697,
                    571,575,690,696,778,788,791,
                    561,589,597,599,688,690,691,696,697,
                    685,691,695,757,
                    691,694,697,757,
                    685,690,691,692,693,788,
                    599,691,693,695,
                    700,710,720,
                    710,713,720,721,
                    698,701,710,
                    700,704,710,716,721,
                    703,707,712,714,715,
                    500,702,706,707,715,719,
                    477,498,701,708,716,
                    709,714,715,716,717,721,
                    500,703,708,715,716,
                    476,702,703,712,718,719,
                    498,500,704,706,716,
                    705,711,714,717,
                    698,699,700,701,720,721,
                    709,717,
                    615,619,702,707,718,
                    699,717,721,
                    702,705,709,715,
                    702,703,705,706,714,716,
                    701,704,705,706,708,715,721,
                    705,709,711,713,721,
                    476,480,491,615,707,712,
                    476,500,703,707,
                    698,699,710,
                    699,701,705,710,713,716,717,
                    757,758,763,768,782,784,
                    747,753,763,776,788,
                    741,746,752,760,774,775,797,
                    554,739,751,759,766,780,798,
                    728,772,774,781,782,
                    745,787,794,800,
                    726,740,744,752,770,772,774,
                    741,758,760,765,774,779,
                    731,751,766,
                    730,751,785,
                    746,762,777,779,
                    742,743,762,775,777,
                    764,767,801,
                    739,747,778,780,789,
                    750,751,755,785,795,
                    740,742,752,775,786,
                    747,749,750,751,780,796,
                    725,735,780,789,798,
                    728,737,744,752,764,786,801,
                    724,729,746,760,779,
                    733,737,773,775,786,799,
                    733,748,793,
                    728,740,745,764,767,770,
                    727,744,767,770,787,790,800,
                    724,732,741,777,779,797,
                    723,735,738,749,776,778,780,788,
                    743,771,793,
                    738,747,750,776,796,
                    736,738,749,751,754,755,776,792,796,
                    725,730,731,736,738,750,766,780,785,
                    724,728,737,740,774,775,
                    685,723,757,763,769,784,788,
                    750,755,783,792,795,
                    736,750,754,795,
                    554,566,571,791,798,
                    685,694,695,722,753,784,
                    722,729,765,774,782,
                    554,725,766,
                    724,729,741,774,
                    771,773,793,
                    732,733,777,
                    722,723,753,768,776,784,792,
                    734,740,744,767,801,
                    729,758,774,
                    725,730,751,759,
                    734,744,745,764,790,
                    722,763,781,782,792,800,
                    685,753,
                    728,744,745,772,800,
                    748,761,793,
                    726,728,770,781,800,
                    742,761,786,799,
                    724,726,728,729,752,758,760,765,782,
                    724,733,737,742,752,777,797,
                    723,747,749,750,763,792,
                    732,733,746,762,775,797,
                    692,735,747,788,789,791,
                    729,732,741,746,
                    725,735,738,739,747,751,
                    726,768,772,782,800,
                    722,726,758,768,774,781,
                    754,787,792,794,
                    722,753,757,763,
                    731,736,751,795,
                    737,740,742,773,
                    727,745,783,790,794,
                    685,692,696,723,747,753,778,
                    735,739,778,791,798,
                    745,767,787,
                    571,692,756,778,789,798,
                    750,754,763,768,776,783,794,800,
                    743,748,761,771,
                    727,783,787,792,800,
                    736,754,755,785,
                    738,749,750,
                    724,746,775,777,
                    554,725,739,756,789,791,
                    742,773,
                    727,745,768,770,772,781,792,794,
                    734,740,764,
                    804,805,815,819,
                    805,814,815,820,
                    802,815,
                    802,803,811,814,815,816,818,819,
                    809,811,813,814,818,820,
                    661,810,812,816,817,818,
                    640,812,
                    806,810,813,818,
                    807,809,813,817,818,
                    805,806,814,818,
                    640,655,661,807,808,816,819,
                    658,806,809,810,817,
                    803,805,806,811,820,
                    802,803,804,805,820,
                    805,807,812,818,819,
                    653,658,661,807,810,813,
                    805,806,807,809,810,811,816,
                    802,805,812,816,
                    803,806,814,815,
                    823,824,
                    135,141,823,826,861,868,
                    821,822,824,825,826,860,
                    821,823,825,869,
                    823,824,849,860,869,
                    822,823,849,860,868,
                    33,832,833,843,845,846,
                    829,831,834,838,839,840,869,
                    828,839,840,844,845,
                    33,836,840,845,
                    33,828,834,838,
                    33,827,833,841,
                    827,832,835,837,841,842,846,
                    33,828,831,840,
                    833,837,842,
                    830,840,845,
                    833,835,842,846,849,880,
                    33,828,831,866,869,
                    828,829,843,844,845,846,849,869,
                    33,828,829,830,834,836,845,
                    33,832,833,842,880,
                    833,835,837,841,880,
                    827,839,845,846,
                    829,839,845,
                    33,827,829,830,836,839,840,843,844,
                    827,833,837,839,843,849,
                    
                    855,858,863,867,884,889,
                    825,826,837,839,846,859,860,861,862,868,869,880,881,
                    853,890,
                    855,858,
                    858,865,885,886,888,902,
                    850,854,864,865,883,890,
                    3,33,853,864,870,871,875,878,890,891,
                    848,851,856,858,867,
                    855,867,889,
                    
                    848,851,852,855,884,885,888,
                    141,142,849,861,862,
                    823,825,826,849,
                    141,822,849,859,868,
                    142,849,859,881,
                    848,869,884,887,
                    853,854,865,878,883,901,
                    852,853,864,888,890,901,902,
                    33,838,869,893,
                    124,848,855,856,889,
                    822,826,849,861,
                    824,825,828,838,839,849,863,866,882,887,893,
                    2,3,32,33,854,871,904,
                    854,870,872,873,875,879,904,
                    871,873,874,876,879,
                    871,872,874,875,876,879,
                    872,873,876,
                    854,871,873,878,879,
                    872,873,874,879,
                    878,879,901,903,
                    854,864,875,877,879,901,
                    871,872,873,875,876,877,878,903,904,
                    33,133,837,841,842,849,881,
                    133,142,849,862,880,
                    869,887,890,892,893,896,
                    853,864,
                    848,858,863,887,888,890,
                    852,858,
                    852,
                    863,869,882,884,890,
                    852,858,865,884,890,
                    848,856,867,
                    850,853,854,865,882,884,887,888,891,894,895,896,
                    3,33,854,890,894,
                    33,882,893,896,
                    33,866,869,882,892,
                    33,890,891,895,
                    33,890,894,896,
                    33,882,890,892,895,
                    428,438,440,442,446,552,898,901,902,
                    416,419,437,440,444,897,900,901,
                    900,901,
                    431,437,447,898,899,901,903,904,
                    864,865,877,878,897,898,899,900,902,903,
                    852,865,897,901,
                    877,879,900,901,904,
                    32,431,870,871,879,900,903
                    ))

##Load initial values####
inits <- function(){
  list(beta0=rnorm(1), sigma.h1=runif(1,0,2),sigma.h2=runif(1,0,2), sigma.t=runif(1,0,2), sigma.w=runif(1,0,2), sigma.nu=runif(1,0,2))
}

inits()

#Parameters to estimate and keep track of
parameters <- c("beta0","tau.h1","tau.h2","tau.t","tau.w","tau.nu","p")

# MCMC settings
nchains <- 1
niter <- 10000
nburnin <- 5000
nthin <- 10

##Locate WinBUGS by setting path below specifically for the computer used.
bugs.dir<-"C:/Users/Annie/Documents/WinBUGS14"

# Do the MCMC stuff from R
out <- bugs(data = bugs.data, inits = inits, parameters.to.save = parameters, model.file = "typhi.bug", n.chains = nchains, n.thin=nthin, n.iter=niter, n.burnin=nburnin, debug=TRUE, bugs.directory=bugs.dir)
summary(out)

my_log <- file("my_log.txt")
sink(my_log, append = TRUE, type = "output")
print(out, 3)
closeAllConnections() 

#get the model predictions

start <- length(mydata$number_resistant[!is.na(mydata$number_resistant)])+length(parameters)
end <- length(out$summary[,1])-1
posterior.df <- data.frame(p.mean = out$summary[start:end,1], 
                           p.sd = out$summary[start:end,2],
                           p.lower=out$summary[start:end,3], 
                           p.upper=out$summary[start:end,7],
                           adj_id = mydata$adj_id[is.na(mydata$number_resistant)],
                           COUNTRY_ID = mydata$COUNTRY_ID[is.na(mydata$number_resistant)],
                           year = mydata$year[is.na(mydata$number_resistant)]+1989)

write.csv(posterior.df,paste0("model_results/bugs/admin1/", model_name, "/bugs_final.csv"), row.names=F)

#check in sample stats #### 
results <- mydata[!is.na(mydata$number_resistant),]
results$year <- results$year+1989
results <- merge(results, posterior.df, by = c('COUNTRY_ID', 'adj_id', 'year'), all.y = T, all.x =T)
coverage <- results$val[!is.na(results$val)]>results$p.lower[!is.na(results$val)] & results$val[!is.na(results$val)]<results$p.upper[!is.na(results$val)]


model_metrics <- data.frame(r2 = cor(results$val[!is.na(results$val)], results$p.mean[!is.na(results$val)])^2,
                            RMSE = RMSE(results$val[!is.na(results$val)], results$p.mean[!is.na(results$val)]),
                            coverage = length(coverage[coverage==TRUE])/length(coverage)*100)

write.csv(model_metrics, paste0('model_results/bugs/admin1/', model_name, '/model_metrics.csv'), row.names = F)

#Plot out model estimates ####
pdf(paste0('model_results/bugs/admin1/', model_name, '/estimates.pdf'),
    height = 8.3, width = 11.7)

#plot out a page for each region
for(i in 1:length(unique(results$COUNTRY_ID))){
  subset <- results[results$COUNTRY_ID == unique(results$COUNTRY_ID)[i],]
  print(
    ggplot(subset)+
      geom_line(aes(x=year, y = p.mean),color = 'green')+
      geom_ribbon(aes(ymin = p.lower, ymax=p.upper, x = year), alpha = 0.1, fill = 'green') +
      geom_point(aes(x = year, y = val))+
      # geom_pointrange(aes(x=year_id, y = val, ymin = lower_ci, ymax = upper_ci)) +
      scale_x_continuous("Year", 
                         breaks = seq(1990, 2018, 5),
                         labels = c("1990", "1995", "2000", "2005", "2010", "2015"))+
      ylim(0,1)+
      ylab('Proportion DR')+
      theme_bw()+
      theme(legend.position = "bottom")+
      ggtitle(unique(subset$COUNTRY_ID))+      
      facet_wrap(~adj_id, nrow = ceiling(sqrt(length(unique(subset$adj_id)))))+
      theme(axis.text.x = element_text(angle = 90, hjust = 1))+
      theme(plot.title = element_text(hjust = 0.5))
  )
}
dev.off()

# Plot map ####
admin0 <- st_read('C:/Users/Annie/Documents/GRAM/shapefiles/admin2013_0.shp')
typhi <- st_read('C:/Users/Annie/Documents/GRAM/shapefiles/typhi_endemic_admin1.shp')
names(typhi) <- c("COUNTRY_ID", "NAME", "GAUL_CODE", "ADMN_LEVEL",  "PARENT_ID",  "spr_rg_id", 
                  "adj_id","adj_sSA", "adj_id_Asia",  "geometry")

typhi_pred <- merge(typhi, posterior.df, by = c('COUNTRY_ID', 'adj_id'))

background <- admin0[!(admin0$COUNTRY_ID %in% typhi_pred$COUNTRY_ID),]
  
  
png(paste0('model_results/bugs/admin1/', model_name, '/5_yr_map.png'),
    height = 30, width = 20, units = 'cm', res = 300)
ggplot()+
  geom_sf(data = background, fill = '#bdbdbd',colour = 'black', size = 0.15)+
  geom_sf(data = typhi_pred[typhi_pred$year == 1990 |
                              typhi_pred$year == 1995 |
                              typhi_pred$year == 2000 |
                              typhi_pred$year == 2005 |
                              typhi_pred$year == 2010 |
                              typhi_pred$year == 2015,], aes(fill = p.mean),colour = NA)+
  geom_sf(data = admin0, fill = NA, colour = 'black', size = 0.15)+
  theme_bw()+
  theme(line = element_blank(),
        axis.text = element_blank())+
  scale_fill_viridis(option='inferno', discrete = F, direction = -1, limits = c(0, 1))+
  labs(fill = 'Proportion MDR')+
  facet_wrap(~year, ncol = 2)+
  xlim(60, 150)+
  ylim(-12,55)
dev.off()
