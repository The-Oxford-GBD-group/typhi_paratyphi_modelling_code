#### SETUP ####
rm(list = ls())
library(R2WinBUGS)
library(sp)
library(spdep)
library(rgdal)
library(coda)
library(data.table)
library(foreign)
library(tidyverse)
library(plyr)
library(ggplot2)
library(viridis)
RMSE = function(m, o){
  sqrt(mean((m - o)^2))
}

setwd("Z:/AMR/Pathogens/typhi_paratyphi")
model_name <- 'MDR_Typhi/22_more_fixed_locs' 
dir.create(paste0('model_results/bugs/admin1/', model_name), showWarnings = F, recursive = T)

##Define the model in BUGS language ####
sink("typhi.bug")
cat("
MODEL 
{ 

    for(i in 1:395){
      h.2[i]~dnorm(0,tau.h2)
  }

  	for(i in 1:N){
      h.1[i]~dnorm(0,tau.h1)
  }
    for(i in 1:nTot){
      number_resistant[i] ~ dbin(p[i],sample_size[i])
    logit(p[i])<-beta0+b[1]*custom_stg1[i]+w.1[adj_id[i]]+h.1[adj_id[i]]+theta.1[year[i]]+h.2[source_num[i]]+nu.1[adj_id[i],year[i]]  
  }


#- Space
w.1[1:N]~car.normal(adj[],weights[],num[],tau.w)

for(k in 1:sumNumNeigh){
				weights[k]<-1
				}
				
# - Time- RW(1)
				
theta.1[1:T] ~ car.normal(adj.t[], weights.t[], num.t[], tau.t)

             for(t in 1:1) {
                weights.t[t] <- 1;
               adj.t[t] <- t+1;
               num.t[t] <- 1
             }
             for(t in 2:(T-1)) {
                weights.t[2+(t-2)*2] <- 1;
              adj.t[2+(t-2)*2] <- t-1
                weights.t[3+(t-2)*2] <- 1;
               adj.t[3+(t-2)*2] <- t+1;
              num.t[t] <- 2
            }
             for(t in T:T) {
                weights.t[(T-2)*2 + 2] <- 1;
               adj.t[(T-2)*2 + 2] <- t-1;
               num.t[t] <- 1
             }

# Space-time Type I interaction
for( i in 1 : N ) {
for( t in 1 : T ) {
nu.1[i,t]~dnorm(0, tau.nu)
}
}

#Hyper priors

# tau.h1~dgamma(0.5,0.0005)
tau.h1 <- pow(sigma.h1,-2)
sigma.h1 ~ dnorm(0,1)I(0,)

# tau.h2~dgamma(0.5,0.0005)
tau.h2 <- pow(sigma.h2,-2)
sigma.h2 ~ dnorm(0,1)I(0,)

# tau.t ~ dgamma(0.5,0.0005)
tau.t <- pow(sigma.t,-2)
sigma.t ~ dnorm(0,1)I(0,)

# tau.w ~ dgamma(0.5, 0.0005)
tau.w <- pow(sigma.w,-2)
sigma.w ~ dnorm(0,1)I(0,)

# tau.nu ~ dgamma(0.5,0.0005)
tau.nu <- pow(sigma.nu,-2)
sigma.nu ~ dnorm(0,1)I(0,)

#Intercepts
beta0~dflat()

#Coefficients

for(i in 1:1){ 
b[i]~dnorm(0,0.1) 
}

}
# end model
", fill=TRUE)
sink()

# Setup the data ####
#get the input data
mydata <- fread("Z:/AMR/Pathogens/typhi_paratyphi/model_prep/clean_data/outliered/MDR_Typhi_outliered.csv")
mydata <- mydata[mydata$is_outlier == 0,]
mydata <- mydata[,.(adj_id, adj_id_sSA, adj_id_Asia, country, year = year_id, source_id =nid, 
                    number_resistant, sample_size, val)]

#get covs (to have a template for all country-years)
# covs <- read.csv("Z:/AMR/Pathogens/typhi_paratyphi/model_results/CAR_INLA/admin1/MDR_Typhi/2021_04_23_sSA/child_model_preds.csv")
covs_ssa <- read.csv("Z:/AMR/Pathogens/typhi_paratyphi/model_results/stacked_ensemble/MDR_Typhi/2021_05_14_sSA/custom_stage1_df.csv")
covs_asia <- read.csv("Z:/AMR/Pathogens/typhi_paratyphi/model_results/stacked_ensemble/MDR_Typhi/2021_05_14_Asia/custom_stage1_df.csv")

all_covs <- read.csv("Z:/AMR/Covariates/modelling_covariates/admin1_typhi/all_admin1_typhi_covs.csv")
# all_covs <- unique(all_covs[c('adj_id', 'adj_id_sSA', 'COUNTRY_ID')])
# covs <- merge(covs, all_covs, all.y = F)

covs_ssa <- merge(covs_ssa, unique(all_covs[c('adj_id', 'COUNTRY_ID')]))
covs_asia <- merge(covs_asia, unique(all_covs[c('adj_id', 'COUNTRY_ID')]))

covs <- rbind(covs_ssa, covs_asia)

rm(covs_ssa, covs_asia, all_covs)

# covs$year_id <-  covs$year_id-2
# covs <- merge(covs, locs, by.x = 'location_id', by.y = 'loc_id')
covs <- covs[order(covs$year_id, covs$adj_id),]
# covs <- covs[!is.na(covs$adj_id_sSA),]
names(covs)[2] <- 'year'
#add the covariates onto the data
mydata <- merge(covs, mydata)

#add the covs data frame onto the data for predictions
# This will mean the data for fitting is on top and prediction on the bottom
mydata <- rbind.fill(mydata, covs)

#Make year id 1:29
mydata$year <- mydata$year-1989

#fill in the missing values (made it work with the aggregated file)
mydata$source_id <- as.numeric(as.factor(mydata$source_id))
mydata$source_id[is.na(mydata$source_id)] <- 395
mydata$sample_size[is.na(mydata$sample_size)] <- 50

#set up adjacency matrix info ####

num <- c(0,3,4,6,2,5,3,6,4,8,5,0,7,2,6,6,6,4,6,6,6,8,3,4,8,4,2,4,7,0,2,7,26,14,
         6,0,0,3,1,1,1,0,0,1,2,0,1,4,2,1,3,1,4,3,2,0,2,1,0,0,3,3,4,4,4,2,4,6,3,
         3,4,1,3,3,3,3,5,7,7,5,6,7,6,8,5,1,5,2,6,6,3,1,7,6,7,6,6,7,3,5,0,0,5,5,
         8,6,5,5,8,4,6,4,6,8,10,6,4,6,5,5,5,4,5,3,5,4,4,3,0,6,7,4,6,3,5,5,7,3,8,
         6,6,8,6,7,3,6,0,0,3,4,4,5,4,5,4,2,3,3,5,4,1,2,4,6,7,3,2,2,7,4,2,0,0,0,2,
         2,3,3,2,1,1,2,3,2,1,5,3,3,4,3,0,0,4,7,6,5,5,4,3,0,0,4,0,4,5,0,0,1,4,4,2,
         0,6,4,7,3,5,3,3,5,4,7,4,0,0,1,0,0,0,0,1,0,0,4,4,6,7,8,4,4,7,7,6,3,4,6,5,
         8,9,4,7,3,9,8,5,5,7,5,7,6,8,8,5,4,4,3,6,4,6,3,4,3,4,5,7,4,4,7,7,5,0,3,4,
         6,2,6,7,5,2,4,3,5,4,6,5,7,6,7,5,5,10,5,4,7,6,5,5,5,5,0,6,5,3,5,3,3,4,2,4,
         5,3,1,3,0,0,0,2,6,7,6,5,4,5,5,5,6,5,7,5,3,7,6,3,4,7,4,7,3,4,6,5,4,4,5,3,
         6,5,4,4,7,3,2,3,5,6,5,3,6,7,6,4,5,5,6,4,5,6,4,4,6,8,4,8,6,6,4,6,4,6,6,0,
         0,0,0,0,0,0,2,2,1,3,7,11,0,5,6,4,3,5,9,3,7,5,3,6,3,8,8,6,5,5,6,5,6,4,3,4,
         4,4,5,6,6,7,4,6,4,5,5,4,6,6,4,3,6,6,7,5,5,8,5,2,3,7,5,4,7,10,2,8,5,3,3,3,
         6,7,5,6,6,4,7,4,5,4,8,8,7,4,6,6,8,4,5,4,6,6,6,4,7,5,4,7,7,5,4,6,7,5,6,6,
         8,4,7,4,6,3,4,13,6,7,2,5,2,11,4,5,5,6,10,6,6,5,4,4,4,4,1,2,3,6,4,4,4,6,4,
         4,3,9,6,4,6,8,4,6,5,7,5,5,7,6,5,6,6,5,9,4,7,3,3,6,4,10,6,6,5,6,7,3,6,5,5,
         5,6,3,5,6,7,7,7,3,7,3,5,6,3,6,5,5,4,10,5,3,4,4,4,2,3,6,1,4,3,4,4,10,4,3,3,
         8,3,8,6,4,6,2,3,8,8,2,8,4,4,6,3,6,4,3,4,4,4,3,6,3,5,5,2,5,3,9,6,5,4,2,3,2,
         3,3,5,4,3,5,2,4,4,6,2,13,6,8,4,5,5,6,8,3,8,3,5,4,3,7,8,7,6,7,9,6,6,6,7,3,4,
         7,6,6,4,7,3,1,8,5,5,6,7,9,4,4,6,4,3,4,3,5,5,6,5,6,5,6,5,4,6,2,5,3,4,6,7,5,
         6,4,3,7,6,5,7,7,5,4,7,6,3,3,4,5,3,5,5,5,6,5,7,5,6,3,6,7,6,8,3,5,9,9,6,7,5,
         4,5,6,5,3,4,3,3,7,5,3,4,5,6,2,5,3,5,4,9,7,6,6,6,4,6,5,6,4,4,4,4,5,7,5,3,6,
         8,4,5,4,3,4,6,2,8,3,4,4,2,8,6,6,2,4,5,4,7,5,5,5,5,6,7,4,4,2,6,6,4,5,5,6,7,
         5,4,4,4,7,4,3,3,6,5,8,7,5,5,4,3,9,6,0,6,13,2,2,6,6,10,5,3,0,7,5,4,5,4,4,6,
         7,4,4,4,11,7,7,5,6,3,5,4,4,6,9,7,5,6,2,6,2,1,5,5,3,12,5,4,5,4,4,5,9,8,2,8,
         10,4,5,7,5,4,7,3,5,6,3,4,6,4,1,5,5,7,6,3,6,3,5,2,6,6,5,5,8,5,6,4,4,5,6,4,6,
         5,5,7,6,5,6,9,5,5,2,3,6,4,6,7,5,3,6,5,8,6,7,4,6,6,7,7,8,4,5,8,5,5,5,5,4,5,
         8,6,8,7,5,6,2,7,5,6,5,8,6,2,3,5,7,5,6,7,6,9,5,7,8,4,6,4,5,8,6,9,8,14,5,5,14,
         3,5,11,17,11,4,6,4,3,5,5,9,6,6,8,0,0,0,4,5,3,2,4,5,0,4,4,5,4,7,1,8,6,5,2,4,
         1,6,7,11,17,5,7,6,6,4,7,5,4,8,4,7,4,5,3,9,6,5,7,4,7,1,6,6,5,6,4,10,1,7,2,5,
         4,3,4,5,3,1,4,4,6,3,2,4,0,2,2,6,4,5,3,3,5,8,3,5,4,16,9,2,4,8,6,4,4,6,3,4,3,
         3,4,7,4,5,5,6,6,5,4,2,4,6,4,5,6,3,6,2,5,4,3,4,6,3,6,7,4,1,5,9,6,7,5,6,8,9,3,
         5,3,5,2,1,3,8,5,10,5,4,8,6,6,2,5,5,6,5,3,1,6,4,6,5,6,6,8,9,8,5,6,1,7,7,6,6,
         3,7,7,6,5,5,4,4,3,5,8,4,6,5,10,7,2,8,7,5,4,9,6,7,7,2,4,4,5,5,6,6,4,6,5,6,8,
         3,7,8,5,4,4,9,6,9,7,1,4,3,4,5,5,6,5,6,7,4,2,4,5,3,4,2,4,6,5,3,6,4,4,3,4,4,5,
         4,4,5,6,8,11,7,4,6,6,6,9,0,0,8,8,5,5,6,4,6,9,4,4,6,5,7,5,5,6,5,4,6,6,7,4,4,
         4,6,5,7,5,6,5,4,6,6,7,1,5,6,11,10,5,4,6,10,7,7,4,3,2,2,4,5,6,7,7,1,2,5,6,2,
         4,5,7,7,4,7,5,5,4,5,5,5,5,8,4,5,6,4,2,5,6,3,6,8,5,6,4,6,7,6,8,5,7,6,5,5,5,4,
         7,6,6,7,5,5,3,6,5,5,5,8,5,5,6,6,4,5,5,5,6,4,6,4,6,7,5,5,7,6,9,8,7,4,4,4,6,5,
         6,9,5,7,4,5,8,7,6,7,2,7,4,8,8,7,7,7,5,6,6,6,5,5,5,6,6,8,4,5,8,6,7,7,7,6,9,3,6,3,6,5,7,5,5,2,3,5,5,7,5,4,5,5,7
)

sumNumNeigh<-sum(num)

#specify data and adjacency matrix ####
bugs.data <- list(N=1474,T=29,nTot=length(mydata$number_resistant),
                  number_resistant=round(mydata$number_resistant,0),sample_size=mydata$sample_size,
                  adj_id = mydata$adj_id, year = mydata$year, source_num = mydata$source_id,
                  custom_stg1 = mydata$cv_custom_stage_1,
                  num=num,sumNumNeigh=sumNumNeigh,
                  adj=c(
                    
                    32,33,870,
                    33,854,870,891,
                    15,16,18,19,26,35,
                    13,31,
                    11,16,17,25,29,
                    9,19,35,
                    22,23,24,25,29,32,
                    7,10,17,19,
                    9,11,17,34,350,357,376,389,
                    6,10,17,29,34,
                    
                    5,15,21,22,26,28,31,
                    20,22,
                    4,13,16,25,26,28,
                    4,6,15,17,19,25,
                    6,9,10,11,16,19,
                    4,26,27,35,
                    4,7,9,16,17,35,
                    14,21,22,213,216,223,
                    13,20,22,35,213,218,
                    8,13,14,20,21,23,25,28,
                    8,22,25,
                    8,29,32,33,
                    6,8,15,16,22,23,28,29,
                    4,13,15,18,
                    18,35,
                    13,15,22,25,
                    6,8,11,24,25,33,34,
                    
                    5,13,
                    2,8,24,33,431,870,904,
                    2,3,24,29,32,34,133,827,830,831,832,834,838,840,841,845,854,866,870,880,891,892,893,894,895,896,
                    10,11,29,33,110,111,112,130,133,144,334,351,353,389,
                    4,7,18,19,21,27,
                    
                    
                    39,40,41,
                    38,
                    38,
                    38,
                    
                    
                    67,
                    58,75,
                    
                    55,
                    66,67,68,76,
                    70,71,
                    67,
                    53,62,63,
                    62,
                    51,63,65,74,
                    65,69,74,
                    47,71,
                    
                    61,69,
                    45,
                    
                    
                    57,67,69,
                    51,52,63,
                    51,53,62,65,
                    72,314,315,322,
                    53,54,63,74,
                    48,68,
                    44,48,50,61,
                    48,66,73,76,168,169,
                    54,57,61,
                    49,71,73,
                    49,55,70,73,
                    64,
                    68,70,71,
                    53,54,65,
                    45,199,209,
                    48,68,169,
                    78,90,97,237,287,
                    77,91,95,97,241,287,302,
                    80,82,84,87,94,338,381,
                    79,81,82,84,95,
                    80,83,84,85,95,100,
                    79,80,87,93,95,97,98,
                    81,85,86,88,100,369,
                    79,80,81,92,94,100,333,360,
                    81,83,88,95,302,
                    83,
                    79,82,89,98,381,
                    83,85,
                    87,96,98,345,381,382,
                    77,93,97,237,294,300,
                    78,241,302,
                    84,
                    82,90,97,98,106,294,304,
                    79,84,99,338,360,365,
                    78,80,81,82,85,97,302,
                    89,98,103,342,345,377,
                    77,78,82,90,93,95,
                    82,87,89,93,96,103,106,
                    94,338,365,
                    81,83,84,333,369,
                    
                    
                    96,98,106,116,342,
                    110,111,115,144,243,
                    108,117,118,119,260,267,331,371,
                    93,98,103,113,116,304,
                    109,119,331,364,383,
                    105,114,260,371,386,
                    107,111,112,115,118,119,334,383,
                    34,104,111,144,
                    34,104,109,110,112,115,
                    34,109,111,334,
                    106,114,116,304,344,373,
                    108,113,234,257,260,304,344,386,
                    104,109,111,118,243,253,264,274,278,307,
                    103,106,113,342,366,373,
                    105,118,253,267,
                    105,109,115,117,119,253,
                    105,107,109,118,331,
                    121,122,123,125,127,
                    120,122,124,126,127,
                    120,121,123,124,
                    120,122,124,125,128,
                    121,122,123,
                    120,123,126,127,128,
                    121,125,127,128,
                    120,121,125,126,
                    123,125,126,
                    
                    34,133,137,142,143,144,
                    132,245,248,276,282,283,284,
                    131,139,146,248,
                    33,34,130,142,880,881,
                    136,145,146,
                    136,140,141,145,822,
                    134,135,140,145,146,
                    130,138,139,143,144,242,255,
                    137,139,255,
                    132,137,138,143,146,248,255,301,
                    135,136,141,142,143,146,
                    135,140,142,822,859,861,
                    130,133,140,141,143,859,862,881,
                    130,137,139,140,142,146,
                    34,104,110,130,137,242,243,
                    134,135,136,
                    132,134,136,139,140,143,
                    
                    
                    154,155,157,
                    151,152,153,156,
                    150,152,154,157,
                    150,151,153,154,155,
                    150,152,155,156,
                    149,151,152,155,157,
                    149,152,153,154,
                    150,153,
                    149,151,154,
                    162,163,164,
                    165,166,167,296,308,
                    164,165,171,265,
                    170,
                    158,163,
                    158,162,164,170,
                    158,160,163,165,170,171,
                    159,160,164,167,170,265,308,
                    159,293,296,
                    159,165,
                    68,169,
                    68,76,168,398,399,400,401,
                    161,163,164,165,
                    160,164,
                    
                    
                    
                    177,178,
                    189,190,
                    175,178,189,
                    175,177,189,
                    182,190,
                    181,
                    180,
                    179,183,
                    182,186,187,
                    186,188,
                    186,
                    183,184,185,187,188,
                    183,186,188,
                    184,186,187,
                    176,177,178,190,
                    176,179,189,
                    
                    
                    194,195,209,210,
                    193,196,199,204,205,209,210,
                    193,196,197,202,204,210,
                    194,195,202,204,205,
                    195,198,202,205,211,
                    197,205,208,211,
                    75,194,209,
                    
                    
                    195,196,197,205,
                    
                    194,195,196,210,
                    194,196,197,198,202,
                    
                    
                    198,
                    75,193,194,199,
                    193,194,195,204,
                    197,198,
                    
                    20,21,218,220,222,223,
                    215,217,221,410,
                    214,217,220,222,402,410,413,
                    20,220,223,
                    214,215,219,221,222,
                    21,213,222,
                    217,221,222,
                    213,215,216,222,223,
                    214,217,219,222,
                    213,215,217,218,219,220,221,
                    20,213,216,220,
                    
                    
                    231,
                    
                    
                    
                    
                    226,
                    
                    
                    114,257,304,309,
                    254,279,295,298,
                    238,259,268,269,289,290,
                    77,90,249,256,261,287,300,
                    236,241,244,258,269,271,287,289,
                    262,295,298,306,
                    249,254,261,275,
                    78,91,238,244,285,287,302,
                    137,144,243,251,252,255,301,
                    104,115,144,242,251,274,
                    238,241,285,
                    131,282,283,299,
                    249,256,257,286,288,305,
                    262,277,278,297,301,
                    131,132,139,259,284,298,301,306,
                    237,240,246,253,256,261,266,275,305,
                    263,272,299,303,
                    242,243,252,274,280,297,301,
                    242,251,301,
                    115,117,118,249,266,267,275,278,305,
                    235,240,261,262,275,279,292,295,
                    137,138,139,242,301,
                    237,246,249,286,300,
                    114,234,246,260,286,288,309,
                    238,261,269,271,292,
                    236,248,268,279,284,290,298,
                    105,108,114,257,267,288,
                    237,240,249,254,258,271,287,292,
                    239,247,254,275,277,295,301,306,
                    250,273,296,299,303,
                    115,274,280,307,
                    160,165,270,308,
                    249,253,305,
                    105,117,253,260,288,305,
                    236,259,269,279,
                    236,238,258,268,279,292,
                    265,296,308,
                    238,258,261,287,
                    250,283,299,
                    263,293,296,303,
                    115,243,251,264,280,
                    240,249,253,254,262,277,278,
                    131,282,284,291,
                    247,262,275,278,
                    115,247,253,275,277,297,307,
                    235,254,259,268,269,292,298,
                    251,264,274,297,307,
                    
                    131,245,276,
                    131,245,272,299,
                    131,248,259,276,290,291,
                    241,244,
                    246,256,257,294,300,309,
                    77,78,237,238,241,261,271,
                    246,257,260,267,305,
                    236,238,
                    236,259,284,291,
                    276,284,290,
                    254,258,261,269,279,
                    166,273,296,303,
                    90,93,286,300,304,309,
                    235,239,254,262,298,
                    159,166,263,270,273,293,308,
                    247,251,278,280,301,307,
                    235,239,248,259,279,295,306,
                    245,250,263,272,283,
                    90,237,256,286,294,
                    139,242,247,248,251,252,255,262,297,306,
                    78,85,91,95,241,
                    250,263,273,293,
                    93,106,113,114,234,294,309,
                    246,249,253,266,267,288,
                    239,248,262,298,301,
                    115,264,278,280,297,
                    159,165,265,270,296,
                    234,257,286,294,304,
                    
                    312,316,317,319,320,321,
                    311,314,315,317,321,
                    318,320,323,
                    64,312,315,317,319,
                    64,312,314,
                    311,319,320,
                    311,312,314,319,
                    313,323,
                    311,314,316,317,
                    311,313,316,321,323,
                    311,312,320,
                    64,
                    313,318,320,
                    
                    
                    
                    366,373,
                    338,352,355,365,372,374,
                    336,337,357,359,384,385,389,
                    336,350,368,370,376,379,
                    105,107,119,364,371,
                    346,354,362,369,
                    84,100,335,360,369,
                    34,109,112,351,383,
                    333,347,354,360,369,
                    329,330,337,350,359,368,
                    329,336,356,368,384,
                    79,94,99,328,352,365,381,
                    340,363,370,380,390,
                    339,378,380,
                    343,345,349,358,374,381,382,
                    96,103,116,366,375,377,
                    341,349,358,
                    113,114,373,386,
                    89,96,341,358,377,382,388,
                    332,347,348,354,
                    335,346,348,354,360,361,372,
                    346,347,361,
                    341,343,355,374,
                    10,330,336,357,359,376,
                    34,334,353,383,385,
                    328,338,374,381,
                    34,351,385,389,
                    332,335,346,347,369,
                    328,349,374,
                    337,368,380,384,387,390,
                    10,329,350,359,389,
                    341,343,345,388,
                    329,336,350,357,
                    84,94,333,335,347,365,372,
                    347,348,372,
                    332,369,
                    339,370,376,
                    107,331,378,383,387,
                    94,99,328,338,360,372,
                    116,327,342,373,375,
                    375,377,388,
                    330,336,337,356,379,390,
                    83,100,332,333,335,354,362,
                    330,339,363,376,379,390,
                    105,108,331,386,
                    328,347,360,361,365,
                    113,116,327,344,366,
                    328,341,349,352,355,381,
                    342,366,367,377,
                    10,330,350,363,370,
                    96,342,345,367,375,388,
                    340,364,380,387,
                    330,368,370,390,
                    339,340,356,378,387,390,
                    79,87,89,338,341,352,374,382,
                    89,341,345,381,
                    107,109,334,351,364,384,385,387,
                    329,337,356,383,385,387,
                    329,351,353,383,384,389,
                    108,114,344,371,
                    356,364,378,380,383,384,
                    345,358,367,377,
                    10,34,329,353,357,385,
                    339,356,368,370,379,380,
                    
                    
                    
                    
                    
                    
                    
                    169,401,
                    169,401,
                    169,
                    169,398,399,
                    215,403,406,409,411,413,415,
                    402,405,406,407,408,409,410,411,412,414,415,
                    
                    403,406,407,410,412,
                    402,403,405,411,412,415,
                    403,405,412,415,
                    403,409,410,
                    402,403,408,410,414,
                    214,215,403,405,408,409,412,413,414,
                    402,403,406,
                    403,405,406,407,410,413,415,
                    215,402,410,412,415,
                    403,409,410,
                    402,403,406,407,412,413,
                    440,444,898,
                    418,423,425,426,435,439,441,446,
                    417,421,422,423,424,441,448,449,
                    430,432,437,444,445,898,
                    423,428,438,446,449,
                    418,424,429,434,441,
                    418,424,432,433,436,448,
                    417,418,420,446,449,
                    418,421,422,427,433,434,
                    417,426,435,541,
                    417,425,439,
                    424,431,433,434,
                    420,438,446,897,
                    421,434,441,443,
                    419,432,444,448,449,
                    32,427,433,447,900,904,
                    419,422,430,436,445,448,
                    422,424,427,431,436,445,447,
                    421,424,427,429,
                    417,425,442,446,541,552,
                    422,432,433,445,
                    419,445,447,898,900,
                    420,428,440,449,897,
                    417,426,441,443,
                    416,438,444,449,897,898,
                    417,418,421,429,439,443,
                    435,446,552,897,
                    429,439,441,
                    416,419,430,440,449,898,
                    419,432,433,436,437,447,
                    417,420,423,428,435,442,897,
                    431,433,437,445,900,
                    418,422,430,432,449,
                    418,420,423,430,438,440,444,448,
                    454,455,457,638,655,
                    453,457,
                    453,457,637,
                    451,452,456,457,637,641,643,
                    450,455,456,457,637,
                    450,454,456,637,
                    453,454,455,457,458,637,641,
                    450,451,452,453,454,456,458,637,638,643,
                    456,457,
                    465,475,478,499,501,1152,1157,1181,
                    468,472,485,503,504,
                    490,496,506,
                    468,471,503,
                    477,479,497,
                    467,482,486,488,492,495,
                    459,475,489,501,630,632,633,
                    469,470,481,495,505,
                    464,474,476,482,488,491,
                    460,462,470,471,485,503,
                    466,470,488,495,
                    466,468,469,471,485,488,505,
                    462,468,470,505,
                    460,487,493,503,504,
                    479,486,492,497,
                    467,478,483,485,488,491,502,504,
                    459,465,478,483,489,494,496,502,
                    467,482,491,500,707,718,719,
                    463,479,498,704,
                    459,474,475,483,491,499,
                    463,473,477,492,497,498,
                    491,499,610,611,615,618,718,1187,
                    466,486,495,497,
                    464,467,476,492,500,
                    474,475,478,502,
                    487,490,493,494,496,502,
                    460,468,470,474,488,504,
                    464,473,481,492,495,497,
                    472,484,490,493,
                    464,467,469,470,474,485,495,
                    465,475,496,506,632,
                    461,484,487,496,
                    467,474,476,478,480,499,718,
                    464,473,479,482,486,498,500,
                    472,484,487,502,504,
                    475,484,496,502,
                    464,466,469,481,486,488,
                    461,475,484,489,490,494,506,
                    463,473,479,481,486,
                    477,479,492,500,704,708,
                    459,478,480,491,1152,1187,
                    476,482,492,498,703,706,708,719,
                    459,465,633,1181,
                    474,475,483,484,493,494,504,
                    460,462,468,472,
                    460,472,474,485,493,502,
                    466,470,471,
                    461,489,496,632,
                    513,515,520,522,523,524,530,532,670,672,678,679,680,
                    511,512,513,514,528,529,
                    511,517,519,521,525,526,528,
                    513,524,
                    508,509,514,517,528,
                    508,529,
                    507,508,510,514,515,516,517,518,520,524,529,
                    508,511,513,517,
                    507,513,518,523,524,
                    513,517,519,520,521,
                    509,511,513,514,516,521,
                    513,515,522,523,529,530,532,603,609,670,
                    509,516,520,521,525,531,
                    507,513,516,519,527,531,
                    509,516,517,519,525,
                    507,518,530,670,
                    507,515,518,532,
                    507,510,513,515,
                    509,519,521,531,
                    509,
                    520,531,
                    508,509,511,
                    508,512,513,518,603,625,
                    507,518,522,532,
                    519,520,525,527,
                    507,518,523,530,
                    540,543,547,548,572,577,
                    538,542,545,546,
                    537,545,546,548,
                    554,556,557,
                    535,538,541,546,548,549,551,555,560,
                    534,537,542,544,546,555,
                    550,556,557,559,
                    533,547,548,549,556,559,
                    425,435,537,544,551,552,555,558,
                    534,538,544,552,
                    533,545,548,572,574,578,
                    538,541,542,552,555,
                    534,535,543,546,548,562,574,
                    534,535,537,538,545,
                    533,540,554,556,577,
                    533,535,537,540,543,545,549,
                    537,540,548,553,559,560,
                    539,551,553,558,559,
                    537,541,550,553,558,560,
                    435,442,541,542,544,897,
                    549,550,551,559,560,
                    536,547,556,566,577,725,756,759,798,
                    537,538,541,544,
                    536,539,540,547,554,557,559,
                    536,539,556,
                    541,550,551,
                    539,540,549,550,553,556,
                    537,549,551,553,
                    565,568,569,573,575,576,589,662,690,693,
                    545,563,570,574,594,655,
                    562,564,565,570,655,662,
                    563,565,568,570,578,
                    561,563,564,568,573,662,
                    554,567,571,575,576,577,756,
                    566,576,577,
                    561,564,565,569,573,578,
                    561,568,572,576,578,
                    562,563,564,574,578,
                    566,575,692,756,791,
                    533,543,569,576,577,578,
                    561,565,568,
                    543,545,562,570,578,
                    561,566,571,576,690,692,
                    561,566,567,569,572,575,577,
                    533,547,554,566,567,572,576,
                    543,564,568,569,570,572,574,
                    580,585,586,
                    579,583,585,586,588,590,591,
                    584,587,657,
                    583,584,587,588,591,
                    580,582,587,588,590,657,
                    581,582,587,
                    579,580,586,589,684,689,
                    579,580,585,589,590,
                    581,582,583,584,657,
                    580,582,583,591,
                    561,585,586,590,657,662,686,688,689,693,
                    580,583,586,589,657,
                    580,582,588,
                    593,594,595,596,
                    592,594,596,655,
                    562,592,593,655,
                    592,596,
                    592,593,595,
                    599,600,601,602,688,693,
                    601,
                    597,601,693,697,
                    597,601,602,
                    597,598,599,600,
                    597,600,684,688,
                    518,529,605,606,607,609,613,614,622,625,
                    612,616,623,624,
                    603,606,613,
                    603,605,614,
                    603,609,610,616,618,620,621,622,
                    623,624,627,
                    518,603,607,618,670,671,1292,1293,
                    480,607,611,615,616,620,
                    480,610,618,620,
                    604,615,616,619,624,626,
                    603,605,
                    603,606,625,
                    480,610,612,616,619,626,712,718,
                    604,607,610,612,615,621,623,626,
                    621,627,
                    480,607,609,611,620,1187,1292,1294,
                    612,615,626,712,
                    607,610,611,618,
                    607,616,617,622,623,627,
                    603,607,621,
                    604,608,616,621,624,627,
                    604,608,612,623,
                    529,603,614,
                    612,615,616,619,
                    608,617,621,623,
                    630,631,633,634,
                    630,631,632,
                    465,628,629,631,632,633,
                    628,629,630,
                    465,489,506,629,630,
                    465,501,628,630,634,
                    628,633,
                    636,637,638,639,642,
                    635,639,642,
                    452,453,454,455,456,457,635,638,642,
                    450,457,635,637,639,655,
                    635,636,638,640,655,
                    639,655,808,812,
                    453,456,
                    635,636,637,
                    453,457,
                    648,649,652,
                    646,647,650,
                    645,647,649,651,652,
                    645,646,650,652,
                    644,649,651,
                    644,646,648,651,652,
                    645,647,
                    646,648,649,655,
                    644,646,647,649,
                    654,658,660,661,664,817,
                    653,660,
                    450,562,563,593,594,638,639,640,651,661,662,664,812,
                    657,659,662,663,664,665,
                    581,583,587,589,590,656,662,665,
                    653,660,813,817,
                    656,660,663,664,665,
                    653,654,658,659,664,
                    653,655,664,807,812,817,
                    561,563,565,589,655,656,657,664,
                    656,659,664,
                    653,655,656,659,660,661,662,663,
                    656,657,659,
                    674,677,1274,1278,1279,
                    669,673,676,683,
                    673,1045,1282,
                    667,670,672,676,681,682,683,
                    507,518,522,609,669,671,672,682,
                    609,670,674,675,682,1285,1293,
                    507,669,670,678,680,681,
                    667,668,676,683,1044,1045,1282,
                    666,671,675,677,682,968,980,1278,1280,
                    671,674,980,1285,1308,1310,
                    667,669,673,677,682,1282,
                    666,674,676,682,1274,1282,
                    507,672,679,680,681,1035,1041,
                    507,678,680,
                    507,672,678,679,
                    669,672,678,683,1035,1039,1050,
                    669,670,671,674,676,677,
                    667,669,673,681,1044,1050,
                    585,602,688,689,
                    691,694,696,753,757,769,788,
                    589,688,689,
                    688,
                    589,597,602,684,686,687,689,693,
                    585,589,684,686,688,
                    561,575,692,693,696,
                    685,693,694,695,696,697,
                    571,575,690,696,778,788,791,
                    561,589,597,599,688,690,691,696,697,
                    685,691,695,757,
                    691,694,697,757,
                    685,690,691,692,693,788,
                    599,691,693,695,
                    700,710,720,
                    710,713,720,721,
                    698,701,710,
                    700,704,710,716,721,
                    703,707,712,714,715,
                    500,702,706,707,715,719,
                    477,498,701,708,716,
                    709,714,715,716,717,721,
                    500,703,708,715,716,
                    476,702,703,712,718,719,
                    498,500,704,706,716,
                    705,711,714,717,
                    698,699,700,701,720,721,
                    709,717,
                    615,619,702,707,718,
                    699,717,721,
                    702,705,709,715,
                    702,703,705,706,714,716,
                    701,704,705,706,708,715,721,
                    705,709,711,713,721,
                    476,480,491,615,707,712,
                    476,500,703,707,
                    698,699,710,
                    699,701,705,710,713,716,717,
                    757,758,763,768,782,784,
                    747,753,763,776,788,
                    741,746,752,760,774,775,797,
                    554,739,751,759,766,780,798,
                    728,772,774,781,782,
                    745,787,794,800,
                    726,740,744,752,770,772,774,
                    741,758,760,765,774,779,
                    731,751,766,
                    730,751,785,
                    746,762,777,779,
                    742,743,762,775,777,
                    764,767,801,
                    739,747,778,780,789,
                    750,751,755,785,795,
                    740,742,752,775,786,
                    747,749,750,751,780,796,
                    725,735,780,789,798,
                    728,737,744,752,764,786,801,
                    724,729,746,760,779,
                    733,737,773,775,786,799,
                    733,748,793,
                    728,740,745,764,767,770,
                    727,744,767,770,787,790,800,
                    724,732,741,777,779,797,
                    723,735,738,749,776,778,780,788,
                    743,771,793,
                    738,747,750,776,796,
                    736,738,749,751,754,755,776,792,796,
                    725,730,731,736,738,750,766,780,785,
                    724,728,737,740,774,775,
                    685,723,757,763,769,784,788,
                    750,755,783,792,795,
                    736,750,754,795,
                    554,566,571,791,798,
                    685,694,695,722,753,784,
                    722,729,765,774,782,
                    554,725,766,
                    724,729,741,774,
                    771,773,793,
                    732,733,777,
                    722,723,753,768,776,784,792,
                    734,740,744,767,801,
                    729,758,774,
                    725,730,751,759,
                    734,744,745,764,790,
                    722,763,781,782,792,800,
                    685,753,
                    728,744,745,772,800,
                    748,761,793,
                    726,728,770,781,800,
                    742,761,786,799,
                    724,726,728,729,752,758,760,765,782,
                    724,733,737,742,752,777,797,
                    723,747,749,750,763,792,
                    732,733,746,762,775,797,
                    692,735,747,788,789,791,
                    729,732,741,746,
                    725,735,738,739,747,751,
                    726,768,772,782,800,
                    722,726,758,768,774,781,
                    754,787,792,794,
                    722,753,757,763,
                    731,736,751,795,
                    737,740,742,773,
                    727,745,783,790,794,
                    685,692,696,723,747,753,778,
                    735,739,778,791,798,
                    745,767,787,
                    571,692,756,778,789,798,
                    750,754,763,768,776,783,794,800,
                    743,748,761,771,
                    727,783,787,792,800,
                    736,754,755,785,
                    738,749,750,
                    724,746,775,777,
                    554,725,739,756,789,791,
                    742,773,
                    727,745,768,770,772,781,792,794,
                    734,740,764,
                    804,805,815,819,
                    805,814,815,820,
                    802,815,
                    802,803,811,814,815,816,818,819,
                    809,811,813,814,818,820,
                    661,810,812,816,817,818,
                    640,812,
                    806,810,813,818,
                    807,809,813,817,818,
                    805,806,814,818,
                    640,655,661,807,808,816,819,
                    658,806,809,810,817,
                    803,805,806,811,820,
                    802,803,804,805,820,
                    805,807,812,818,819,
                    653,658,661,807,810,813,
                    805,806,807,809,810,811,816,
                    802,805,812,816,
                    803,806,814,815,
                    823,824,
                    135,141,823,826,861,868,
                    821,822,824,825,826,860,
                    821,823,825,869,
                    823,824,849,860,869,
                    822,823,849,860,868,
                    33,832,833,843,845,846,
                    829,831,834,838,839,840,869,
                    828,839,840,844,845,
                    33,836,840,845,
                    33,828,834,838,
                    33,827,833,841,
                    827,832,835,837,841,842,846,
                    33,828,831,840,
                    833,837,842,
                    830,840,845,
                    833,835,842,846,849,880,
                    33,828,831,866,869,
                    828,829,843,844,845,846,849,869,
                    33,828,829,830,834,836,845,
                    33,832,833,842,880,
                    833,835,837,841,880,
                    827,839,845,846,
                    829,839,845,
                    33,827,829,830,836,839,840,843,844,
                    827,833,837,839,843,849,
                    
                    855,858,863,867,884,889,
                    825,826,837,839,846,859,860,861,862,868,869,880,881,
                    853,890,
                    855,858,
                    858,865,885,886,888,902,
                    850,854,864,865,883,890,
                    3,33,853,864,870,871,875,878,890,891,
                    848,851,856,858,867,
                    855,867,889,
                    
                    848,851,852,855,884,885,888,
                    141,142,849,861,862,
                    823,825,826,849,
                    141,822,849,859,868,
                    142,849,859,881,
                    848,869,884,887,
                    853,854,865,878,883,901,
                    852,853,864,888,890,901,902,
                    33,838,869,893,
                    848,855,856,889,
                    822,826,849,861,
                    824,825,828,838,839,849,863,866,882,887,893,
                    2,3,32,33,854,871,904,
                    854,870,872,873,875,879,904,
                    871,873,874,876,879,
                    871,872,874,875,876,879,
                    872,873,876,
                    854,871,873,878,879,
                    872,873,874,879,
                    878,879,901,903,
                    854,864,875,877,879,901,
                    871,872,873,875,876,877,878,903,904,
                    33,133,837,841,842,849,881,
                    133,142,849,862,880,
                    869,887,890,892,893,896,
                    853,864,
                    848,858,863,887,888,890,
                    852,858,
                    852,
                    863,869,882,884,890,
                    852,858,865,884,890,
                    848,856,867,
                    850,853,854,865,882,884,887,888,891,894,895,896,
                    3,33,854,890,894,
                    33,882,893,896,
                    33,866,869,882,892,
                    33,890,891,895,
                    33,890,894,896,
                    33,882,890,892,895,
                    428,438,440,442,446,552,898,901,902,
                    416,419,437,440,444,897,900,901,
                    900,901,
                    431,437,447,898,899,901,903,904,
                    864,865,877,878,897,898,899,900,902,903,
                    852,865,897,901,
                    877,879,900,901,904,
                    32,431,870,871,879,900,903,
                    910,914,915,921,922,
                    910,912,913,920,
                    909,910,912,913,917,918,919,
                    1007,1020,1023,
                    907,911,913,919,1464,
                    905,906,907,912,914,918,
                    909,913,920,
                    906,907,910,913,
                    906,907,909,911,912,920,
                    905,910,918,921,
                    905,
                    917,918,1006,1009,1011,
                    907,916,918,919,1011,
                    907,910,914,916,917,921,1006,
                    907,909,917,1011,1461,1464,
                    906,911,913,
                    905,914,918,922,1006,1007,
                    905,921,1007,
                    925,928,931,934,1016,
                    925,1016,
                    923,924,926,934,936,1016,
                    925,929,933,936,938,1016,
                    930,935,939,1322,1323,
                    923,931,1016,1235,1236,
                    926,930,931,934,936,937,938,939,
                    927,929,935,937,939,
                    923,928,929,934,937,1235,
                    935,937,1232,1235,
                    926,938,1016,1323,
                    923,925,929,931,936,
                    927,930,932,937,1232,1322,
                    925,926,929,934,
                    929,930,931,932,935,1235,
                    926,929,933,939,1323,
                    927,929,930,938,1323,
                    941,943,959,1189,1193,1209,1213,
                    940,943,946,959,1314,1317,
                    945,947,948,949,951,
                    940,941,944,946,1211,1213,
                    943,946,950,951,1211,1214,1216,1313,1316,
                    942,948,951,1315,1316,
                    941,943,944,1313,1314,
                    942,949,
                    942,945,1315,
                    942,947,950,951,1212,1214,
                    944,949,951,1214,
                    942,944,945,949,950,1316,
                    957,960,961,964,1154,1155,1156,
                    960,964,984,986,1156,
                    957,958,962,
                    956,958,959,962,1068,1317,
                    955,959,961,962,963,
                    952,954,958,961,962,964,1068,1069,
                    954,955,957,962,1068,1069,
                    940,941,955,956,963,1193,1317,
                    952,953,964,1156,
                    952,956,957,962,963,1154,
                    954,955,956,957,958,961,
                    956,959,961,1150,1154,1157,1193,
                    952,953,957,960,986,1067,1069,
                    968,973,976,977,980,1289,1305,1306,
                    968,972,976,1008,
                    968,972,1015,1280,1281,
                    674,965,966,967,972,976,980,1280,
                    973,975,976,977,1008,
                    971,975,979,1008,1022,
                    970,974,975,979,998,
                    966,967,968,1008,1015,
                    965,969,976,977,
                    971,975,978,996,998,
                    969,970,971,974,977,978,981,1008,
                    965,966,968,969,973,1008,
                    965,969,973,975,978,1300,1305,1307,
                    974,975,977,996,1001,1300,1301,
                    970,971,998,1022,1026,
                    674,675,965,968,1289,1310,
                    975,1008,
                    990,992,993,994,1117,1121,1125,
                    984,995,1075,1079,1156,
                    953,983,985,986,995,1156,
                    984,986,991,994,995,
                    953,964,984,985,987,991,1063,1067,
                    986,988,991,992,1063,1071,
                    987,992,
                    990,991,994,
                    982,989,991,992,994,
                    985,986,987,989,990,992,994,
                    982,987,988,990,991,
                    982,994,995,1079,1117,1123,
                    982,985,989,990,991,993,995,
                    983,984,985,993,994,1079,
                    974,978,997,998,1001,1002,1003,1195,1217,
                    996,998,1000,1003,1004,
                    971,974,979,996,997,1004,1026,
                    1001,1195,1199,1287,1297,1302,1303,1304,
                    997,1003,1004,1005,
                    978,996,999,1195,1301,1304,
                    996,1003,1005,1217,
                    996,997,1000,1002,1005,
                    997,998,1000,1026,1061,1099,1100,1101,
                    1000,1002,1003,1198,1200,1217,
                    916,918,921,1007,1008,1009,1012,1024,1025,
                    908,921,922,1006,1012,1017,1023,1025,
                    966,969,970,972,975,976,981,1006,1009,1010,1015,1018,1022,1024,
                    916,1006,1008,1010,1011,
                    1008,1009,1011,1013,1015,
                    916,917,919,1009,1010,1013,1016,1323,1335,1456,1457,1459,1461,1462,
                    1006,1007,1025,
                    1010,1011,1014,1015,1016,
                    1013,1015,1016,1234,1236,1355,1385,1422,1424,1432,1436,
                    967,972,1008,1010,1013,1014,1275,1281,1354,1355,1377,1380,1381,1388,1393,1418,1448,
                    923,924,925,926,928,933,1011,1013,1014,1236,1323,
                    1007,1021,1023,1025,
                    1008,1019,1022,1024,1026,1054,
                    1018,1026,1054,1058,
                    908,1023,1057,
                    1017,1023,1024,1025,1054,
                    970,979,1008,1018,1026,
                    908,1007,1017,1020,1021,1054,1056,1057,1059,
                    1006,1008,1018,1021,1025,1054,
                    1006,1007,1012,1017,1021,1024,
                    979,998,1004,1018,1019,1022,1058,1061,
                    
                    
                    
                    1031,1032,1052,1255,
                    1030,1032,1034,1043,1052,
                    1030,1031,1255,
                    1034,1038,
                    1031,1033,1038,1043,
                    678,681,1039,1040,1041,
                    
                    1039,1040,1041,1050,
                    1033,1034,1041,1043,
                    681,1035,1037,1040,1050,
                    1035,1037,1039,1041,
                    678,1035,1037,1038,1040,1043,1050,
                    1051,
                    1031,1034,1038,1041,1044,1050,1051,1052,
                    673,683,1043,1045,1050,1051,
                    668,673,1044,1051,1282,
                    1051,1052,
                    1049,1051,1277,1282,
                    1051,
                    1047,1051,1105,1109,1276,1277,
                    681,683,1037,1039,1041,1043,1044,
                    1042,1043,1044,1045,1046,1047,1048,1049,1052,1105,1282,
                    1030,1031,1043,1046,1051,1105,1107,1255,1256,1260,1261,1262,1267,1268,1270,1271,1272,
                    1055,1060,1061,1099,1101,
                    1018,1019,1021,1023,1024,1058,1059,
                    1053,1056,1058,1059,1060,1061,
                    1023,1055,1057,1058,1059,1060,
                    1020,1023,1056,1060,
                    1019,1026,1054,1055,1056,1059,1061,
                    1023,1054,1055,1056,1058,
                    1053,1055,1056,1057,
                    1004,1026,1053,1055,1058,1099,1100,1102,
                    1063,1064,1065,1071,
                    986,987,1062,1065,1067,1070,1071,
                    1062,1065,1066,1071,
                    1062,1063,1064,1066,1070,
                    1064,1065,1070,
                    964,986,1063,1068,1069,1070,1313,1314,1317,
                    955,957,958,1067,1069,1317,
                    957,958,964,1067,1068,
                    1063,1065,1066,1067,1313,1315,1316,
                    987,1062,1063,1064,
                    1076,1077,1091,1095,1238,1239,1241,
                    1076,
                    1075,1077,1078,1079,1151,1252,
                    983,1074,1079,1151,1153,1156,
                    1072,1073,1077,1078,1252,
                    1072,1074,1076,1078,1151,1238,
                    1074,1076,1077,1252,
                    983,993,995,1074,1075,1113,1119,1123,1251,1252,
                    1082,
                    1083,1084,1085,1237,1239,1241,1242,
                    1080,1086,
                    1081,1084,1086,1239,1240,
                    1081,1083,1237,1247,
                    1081,1239,1241,
                    1082,1083,1240,1245,
                    1091,1092,1093,1095,1239,
                    1090,1092,1094,
                    1093,
                    1088,1092,1240,1245,
                    1072,1087,1095,1239,
                    1087,1088,1090,1094,1239,1240,
                    1087,1089,1095,
                    1088,1092,
                    1072,1087,1091,1093,
                    
                    1101,1098,
                    1101,1097,
                    1004,1053,1061,1100,1101,1102,
                    1004,1061,1099,1102,
                    1004,1053,1097,1098,1099,
                    1061,1099,1100,
                    1105,1106,1109,
                    1105,1107,1109,1324,1342,
                    1049,1051,1052,1103,1104,1106,1107,1109,
                    1103,1105,1109,
                    1052,1104,1105,1261,1263,
                    1109,1110,1327,1411,
                    1049,1103,1104,1105,1106,1108,1110,1111,1276,1318,1324,1327,1345,1352,1373,1444,
                    1108,1109,1352,1367,1370,1394,1411,1417,1455,
                    1109,1276,
                    1113,1114,1116,1122,
                    1079,1112,1114,1115,1119,1120,1122,1123,
                    1112,1113,1116,1119,1122,1251,
                    1113,1120,1123,1124,
                    1112,1114,1251,1253,
                    982,993,1123,1124,1125,1126,
                    1121,1125,1126,
                    1079,1113,1114,1251,
                    1113,1115,1122,
                    982,1118,1125,
                    1112,1113,1114,1120,
                    993,1079,1113,1115,1117,1124,1126,
                    1115,1117,1123,1126,
                    982,1117,1118,1121,1126,
                    1117,1118,1123,1124,1125,
                    1129,1130,1135,1136,1146,1147,
                    1133,1135,1140,1144,1147,1148,
                    1127,1136,1138,1142,1147,
                    1127,1135,1145,1146,
                    1132,1133,
                    1131,1133,1134,1141,
                    1128,1131,1132,1140,1141,1144,
                    1132,1140,1141,1148,
                    1127,1128,1130,1147,1148,
                    1127,1129,1137,1138,1143,1146,
                    1136,1143,1146,
                    1129,1136,1142,1143,1144,1147,
                    1145,1146,
                    1128,1133,1134,1141,1148,
                    1132,1133,1134,1140,
                    1129,1138,1147,
                    1136,1137,1138,1144,
                    1128,1133,1138,1143,1147,1166,
                    1130,1139,1146,
                    1127,1130,1136,1137,1139,1145,
                    1127,1128,1129,1135,1138,1142,1144,
                    1128,1134,1135,1140,
                    1153,
                    963,1152,1157,1192,1193,
                    1074,1075,1077,1153,1171,1175,1177,1238,1241,
                    459,499,1150,1157,1187,1192,
                    1075,1149,1151,1155,1156,1176,1177,
                    952,961,963,1155,1157,
                    952,1153,1154,1156,1157,1176,
                    952,953,960,983,984,1075,1153,1155,
                    459,963,1150,1152,1154,1155,1170,1176,1181,
                    1164,1165,1330,
                    1160,1161,1162,1467,1470,
                    1159,1161,1166,
                    1159,1160,1166,1167,1467,
                    1159,1163,
                    1162,
                    1158,1165,1168,
                    1158,1164,1168,1169,1185,1186,1330,1336,
                    1144,1160,1161,1167,1168,
                    1161,1166,1168,1183,1185,1458,1460,1467,1468,1474,
                    1164,1165,1166,1167,1185,
                    1165,1184,1185,1186,
                    1157,1172,1173,1176,1178,1180,1181,1182,
                    1151,1172,1174,1175,1177,1180,
                    1170,1171,1174,1180,1182,1250,
                    1170,1178,
                    1171,1172,1175,1249,1250,
                    1151,1171,1174,1241,1249,
                    1153,1155,1157,1170,1177,1180,
                    1151,1153,1171,1176,1180,
                    1170,1173,1182,
                    1182,
                    1170,1171,1172,1176,1177,1182,
                    459,501,1157,1170,
                    1170,1172,1178,1179,1180,1250,
                    1167,1184,1185,1186,1458,
                    1169,1183,1186,1328,1458,1462,
                    1165,1167,1168,1169,1183,1186,
                    1165,1169,1183,1184,1185,1321,1328,1336,
                    480,499,618,1152,1188,1190,1192,1194,1294,
                    1187,1194,1199,1218,1287,1292,1294,1299,
                    940,1192,1193,1209,1230,
                    1187,1192,1194,1208,1230,1231,
                    1193,
                    1150,1152,1187,1189,1190,1193,1230,
                    940,959,963,1150,1189,1191,1192,
                    1187,1188,1190,1205,1208,1218,
                    996,999,1001,1199,1217,1225,
                    1200,1219,1229,
                    1201,1202,1204,1210,1219,1224,1229,
                    1005,1200,1210,1217,1222,1224,1226,
                    999,1188,1195,1218,1225,1287,
                    1005,1196,1198,1219,1222,
                    1197,1202,1221,1227,1229,
                    1197,1201,1210,1227,
                    1206,1210,1213,1226,
                    1197,1219,1229,
                    1194,1207,1208,1218,1220,
                    1203,1207,1208,1213,1220,1226,1228,1231,
                    1205,1206,1208,1220,
                    1190,1194,1205,1206,1207,1231,
                    940,1189,1213,1230,1231,
                    1197,1198,1202,1203,1211,1213,1223,1224,1226,1227,
                    943,944,1210,1213,1215,1216,1223,
                    949,1214,
                    940,943,1203,1206,1209,1210,1211,1231,
                    944,949,950,1212,1215,1216,1227,
                    1211,1214,1216,1223,1227,
                    944,1211,1214,1215,
                    996,1002,1005,1195,1198,1220,1225,1226,1228,
                    1188,1194,1199,1205,1220,1225,
                    1196,1197,1200,1204,1222,1224,1229,
                    1205,1206,1207,1217,1218,1225,1228,
                    1201,1229,
                    1198,1200,1219,1224,
                    1210,1211,1215,1227,
                    1197,1198,1210,1219,1222,
                    1195,1199,1217,1218,1220,
                    1198,1203,1206,1210,1217,1228,
                    1201,1202,1210,1214,1215,1223,
                    1206,1217,1220,1226,
                    1196,1197,1201,1204,1219,1221,
                    1189,1190,1192,1209,1231,
                    1190,1206,1208,1209,1213,1230,
                    932,935,1233,1234,1235,1322,1420,1426,
                    1232,1234,1235,
                    1014,1232,1233,1235,1236,1420,1424,
                    928,931,932,937,1232,1233,1234,1236,
                    928,1014,1016,1234,1235,
                    1081,1084,1242,1247,
                    1072,1077,1151,1241,
                    1072,1081,1083,1085,1087,1091,1092,1240,1241,
                    1083,1086,1090,1092,1239,1245,
                    1072,1081,1085,1151,1175,1238,1239,1242,1249,
                    1081,1237,1241,1246,1247,1248,1249,
                    1244,
                    1243,1246,1247,1248,
                    1086,1090,1240,
                    1242,1244,1247,1248,
                    1084,1237,1242,1244,1246,
                    1242,1244,1246,1249,1250,
                    1174,1175,1241,1242,1248,1250,
                    1172,1174,1182,1248,1249,
                    1079,1114,1116,1119,1252,1253,
                    1074,1076,1078,1079,1251,1253,1254,
                    1116,1251,1252,1254,
                    1252,1253,
                    1030,1032,1052,1272,
                    1052,1258,1261,1262,1264,
                    1268,1269,1270,
                    1256,1261,1264,1265,
                    1264,1266,
                    1052,1262,1266,1267,
                    1052,1107,1256,1258,1263,1265,
                    1052,1256,1260,1264,1266,
                    1107,1261,1265,
                    1256,1258,1259,1262,1265,1266,
                    1258,1261,1263,1264,
                    1259,1260,1262,1264,
                    1052,1260,1268,
                    1052,1257,1267,1270,
                    1257,1270,1271,1272,
                    1052,1257,1268,1269,1271,
                    1052,1269,1270,1272,
                    1052,1255,1269,1271,
                    1274,1275,1277,1279,1281,
                    666,677,1273,1277,1279,1282,
                    1015,1273,1276,1277,1281,1425,1438,1448,
                    1049,1109,1111,1275,1277,1346,1364,1368,1416,1425,1444,
                    1047,1049,1273,1274,1275,1276,1282,
                    666,674,1279,1280,
                    666,1273,1274,1278,1280,1281,
                    674,967,968,1278,1279,1281,
                    967,1015,1273,1275,1279,1280,
                    668,673,676,677,1045,1047,1051,1274,1277,
                    
                    
                    671,675,1290,1291,1292,1293,1308,1309,
                    1289,1290,1291,1295,1296,1305,1306,1309,
                    999,1188,1199,1297,1299,
                    1300,1301,1304,1311,1312,
                    965,980,1286,1306,1309,1310,
                    1285,1286,1291,1309,
                    1285,1286,1290,1292,1296,1298,
                    609,618,1188,1285,1291,1293,1294,1298,1299,
                    609,671,1285,1292,
                    618,1187,1188,1292,
                    1286,1296,1297,1303,1305,1311,
                    1286,1291,1295,1297,1298,
                    999,1287,1295,1296,1298,1299,1303,
                    1291,1292,1296,1297,1299,
                    1188,1287,1292,1297,1298,
                    977,978,1288,1301,1307,1311,
                    978,1001,1288,1300,1304,
                    999,1303,1304,1312,
                    999,1295,1297,1302,1311,1312,
                    999,1001,1288,1301,1302,1312,
                    965,977,1286,1295,1306,1307,1311,
                    965,1286,1289,1305,
                    977,1300,1305,1311,
                    675,1285,1309,1310,
                    1285,1286,1289,1290,1308,1310,
                    675,980,1289,1308,1309,
                    1288,1295,1300,1303,1305,1307,1312,
                    1288,1302,1303,1304,1311,
                    944,946,1067,1070,1314,1316,
                    941,946,1067,1313,1317,
                    945,948,1070,1316,
                    944,945,951,1070,1313,1315,
                    941,955,959,1067,1068,1314,
                    1109,1320,1324,1326,1327,1337,1338,
                    1334,
                    1318,1321,1326,1329,1338,
                    1186,1320,1328,1329,1336,1338,
                    927,935,1232,1323,1327,1331,1337,1414,1421,1426,1443,
                    927,933,938,939,1011,1016,1322,1335,1337,1341,
                    1104,1109,1318,1326,1342,
                    1329,1330,1334,1336,
                    1318,1320,1324,1329,1338,1342,
                    1108,1109,1318,1322,1331,1337,1395,1411,1421,1434,
                    1184,1186,1321,1335,1338,1341,1462,
                    1320,1321,1325,1326,1334,1336,1342,
                    1158,1165,1325,1336,
                    1322,1327,1337,
                    1339,1342,
                    1340,1343,
                    1319,1325,1329,1342,
                    1011,1323,1328,1341,1462,
                    1165,1186,1321,1325,1329,1330,
                    1318,1322,1323,1327,1331,1338,1341,
                    1318,1320,1321,1326,1328,1337,1341,
                    1332,
                    1333,1343,
                    1323,1328,1335,1337,1338,
                    1104,1324,1326,1329,1332,1334,
                    1333,1340,
                    1366,1376,1382,1391,
                    1109,1352,1367,1373,1374,
                    1276,1368,1377,1393,1397,1407,1416,
                    1365,1383,1390,1400,1413,1435,1439,
                    1399,1412,1441,1450,
                    1359,1375,1411,1417,1434,1441,1455,
                    1395,1410,1419,1433,1434,
                    1360,1371,1396,1409,1427,
                    1109,1110,1345,1367,
                    1362,1367,1374,1386,1389,
                    1015,1372,1377,1407,1418,
                    1014,1015,1380,1422,1428,
                    1363,1379,1385,1403,1436,
                    1361,1369,1408,1412,1429,1433,1439,1445,
                    1360,1396,1406,1452,
                    1349,1369,1375,1434,1445,
                    1351,1358,1371,1396,1406,1421,
                    1357,1369,1419,1433,
                    1353,1367,
                    1356,1379,1403,1426,1451,
                    1276,1366,1368,1384,1391,1444,
                    1347,1383,1413,
                    1344,1364,1373,1376,1391,1444,
                    1110,1345,1352,1353,1362,1374,1386,1394,
                    1276,1346,1364,1384,1397,
                    1357,1359,1361,1419,1434,1445,
                    1110,1394,1450,1455,
                    1351,1360,1406,1409,1414,1421,
                    1354,1400,1402,1407,1418,1435,1454,
                    1109,1345,1366,1374,1376,1444,
                    1345,1353,1367,1373,1376,1389,1401,1446,
                    1349,1359,1399,1441,1445,
                    1344,1366,1373,1374,1382,1440,1446,
                    1015,1346,1354,1388,1393,1407,
                    1387,1401,1408,1412,1446,
                    1356,1363,1385,1442,1451,
                    1015,1355,1418,1423,1428,
                    1015,1393,1438,1448,
                    1344,1376,1384,1391,1392,1413,1440,
                    1347,1365,1397,1400,1407,1413,
                    1364,1368,1382,1391,1397,1413,
                    1014,1356,1379,1422,1431,1436,1442,
                    1353,1367,1389,1394,1450,
                    1378,1408,1429,1440,1446,
                    1015,1377,1393,
                    1353,1374,1386,1401,1412,1450,
                    1347,1392,1413,1429,1439,
                    1344,1364,1366,1382,1384,
                    1382,1390,1413,1429,1440,
                    1015,1346,1377,1381,1388,1416,1425,1438,
                    1110,1367,1370,1386,1450,
                    1327,1350,1410,1421,1434,
                    1351,1358,1360,1427,1452,1453,
                    1346,1368,1383,1384,1407,1413,
                    1402,1452,1453,1454,
                    1348,1375,1412,1441,1445,
                    1347,1372,1383,1407,1435,
                    1374,1378,1389,1412,1446,
                    1372,1398,1418,1423,1453,1454,
                    1356,1363,1426,1436,
                    1405,1423,1427,1431,1447,1453,
                    1404,1423,1428,1431,
                    1358,1360,1371,1421,1437,1452,
                    1346,1354,1372,1377,1383,1397,1400,
                    1357,1378,1387,1412,1429,
                    1351,1371,1414,1415,1427,
                    1350,1395,1421,1430,1433,1437,1449,
                    1108,1110,1327,1349,1417,1434,
                    1348,1357,1378,1389,1399,1401,1408,1445,1450,
                    1347,1365,1382,1383,1384,1390,1392,1397,
                    1322,1371,1409,1415,1421,1443,1447,
                    1409,1414,1427,1447,
                    1276,1346,1393,1425,
                    1110,1349,1411,1455,
                    1015,1354,1372,1380,1402,1423,
                    1350,1361,1369,1433,1434,
                    1232,1234,1424,1426,1432,1436,
                    1322,1327,1360,1371,1395,1406,1410,1414,1437,
                    1014,1355,1385,1428,1431,
                    1380,1402,1404,1405,1418,1428,1453,
                    1014,1234,1420,1432,
                    1275,1276,1393,1416,1438,
                    1232,1322,1363,1403,1420,1436,1443,1451,
                    1351,1396,1404,1409,1415,1447,1453,
                    1355,1380,1405,1422,1423,1431,
                    1357,1387,1390,1392,1408,1439,1440,
                    1410,1437,
                    1385,1404,1405,1422,1428,1442,1447,
                    1014,1420,1424,1436,
                    1350,1357,1361,1410,1419,1435,1439,1449,
                    1327,1349,1350,1359,1369,1395,1411,1419,
                    1347,1372,1400,1433,1439,1449,1454,
                    1014,1356,1385,1403,1420,1426,1432,
                    1406,1410,1421,1430,1449,1452,1454,
                    1275,1381,1393,1425,1448,
                    1347,1357,1390,1429,1433,1435,
                    1376,1382,1387,1392,1429,1446,
                    1348,1349,1375,1399,1450,1455,
                    1379,1385,1431,1447,1451,
                    1322,1414,1426,1447,1451,
                    1109,1276,1364,1366,1373,
                    1357,1359,1369,1375,1399,1412,
                    1374,1376,1378,1387,1401,1440,
                    1404,1414,1415,1427,1431,1442,1443,1451,
                    1015,1275,1381,1438,
                    1410,1433,1435,1437,1454,
                    1348,1370,1386,1389,1394,1412,1441,1455,
                    1363,1379,1426,1442,1443,1447,
                    1358,1396,1398,1406,1437,1453,1454,
                    1396,1398,1402,1404,1423,1427,1452,
                    1372,1398,1402,1435,1437,1449,1452,
                    1110,1349,1370,1417,1441,1450,
                    1011,1457,1458,1459,1460,1461,1462,1463,1464,
                    1011,1456,1461,
                    1167,1183,1184,1456,1460,1462,
                    1011,1456,1462,
                    1167,1456,1458,1463,1468,1469,
                    919,1011,1456,1457,1464,
                    1011,1184,1328,1335,1456,1458,1459,
                    1456,1460,1464,1469,1473,
                    909,919,1456,1461,1463,
                    1471,1473,
                    1468,1469,1474,
                    1159,1161,1167,1470,1474,
                    1167,1460,1466,1469,1474,
                    1460,1463,1466,1468,1472,1473,1474,
                    1159,1467,1471,1472,1474,
                    1465,1470,1472,1473,
                    1469,1470,1471,1473,1474,
                    1463,1465,1469,1471,1472,
                    1167,1466,1467,1468,1469,1470,1472))

##Load initial values####
inits <- function(){
  list(beta0=rnorm(1), sigma.h1=runif(1,0,2),sigma.h2=runif(1,0,2), sigma.t=runif(1,0,2), sigma.w=runif(1,0,2), sigma.nu=runif(1,0,2))
}

inits()

#Paramters to estimate and keep track of
parameters <- c("beta0","tau.h1","tau.h2","tau.t","tau.w","tau.nu","p")

# MCMC settings
nchains <- 1
niter <- 10000
nburnin <- 5000
nthin <- 10

##Locate WinBUGS by setting path below specifically for the computer used.
bugs.dir<-"C:/Users/annieb/Documents/WinBUGS14"

# Do the MCMC stuff from R
out <- bugs(data = bugs.data, inits = inits, parameters.to.save = parameters, model.file = "typhi.bug", n.chains = nchains, n.thin=nthin, n.iter=niter, n.burnin=nburnin, debug=TRUE, bugs.directory=bugs.dir)
summary(out)

my_log <- file("my_log.txt")
sink(my_log, append = TRUE, type = "output")
print(out, 3)
closeAllConnections() 

#get the model predictions

start <- length(mydata$number_resistant[!is.na(mydata$number_resistant)])+length(parameters)
end <- length(out$summary[,1])-1
posterior.df <- data.frame(p.mean = out$summary[start:end,1], 
                           p.sd = out$summary[start:end,2],
                           p.lower=out$summary[start:end,3], 
                           p.upper=out$summary[start:end,7],
                           adj_id = mydata$adj_id[is.na(mydata$number_resistant)],
                           COUNTRY_ID = mydata$COUNTRY_ID[is.na(mydata$number_resistant)],
                           year = mydata$year[is.na(mydata$number_resistant)]+1989)

write.csv(posterior.df,paste0("model_results/bugs/admin1/", model_name, "/bugs_final.csv"), row.names=F)

#check in sample stats #### 
results <- mydata[!is.na(mydata$number_resistant),]
results$year <- results$year+1989
results <- merge(results, posterior.df, by = c('COUNTRY_ID', 'adj_id', 'year'), all.y = T, all.x =T)
coverage <- results$val[!is.na(results$val)]>results$p.lower[!is.na(results$val)] & results$val[!is.na(results$val)]<results$p.upper[!is.na(results$val)]


model_metrics <- data.frame(r2 = cor(results$val[!is.na(results$val)], results$p.mean[!is.na(results$val)])^2,
                            RMSE = RMSE(results$val[!is.na(results$val)], results$p.mean[!is.na(results$val)]),
                            coverage = length(coverage[coverage==TRUE])/length(coverage)*100)

write.csv(model_metrics, paste0('model_results/bugs/admin1/', model_name, '/model_metrics.csv'), row.names = F)

#Plot out model estimates ####
pdf(paste0('model_results/bugs/admin1/', model_name, '/estimates.pdf'),
    height = 8.3, width = 11.7)

#plot out a page for each region
for(i in 1:length(unique(results$COUNTRY_ID))){
  subset <- results[results$COUNTRY_ID == unique(results$COUNTRY_ID)[i],]
  print(
    ggplot(subset)+
      geom_line(aes(x=year, y = p.mean),color = 'green')+
      geom_ribbon(aes(ymin = p.lower, ymax=p.upper, x = year), alpha = 0.1, fill = 'green') +
      geom_point(aes(x = year, y = val))+
      # geom_pointrange(aes(x=year_id, y = val, ymin = lower_ci, ymax = upper_ci)) +
      scale_x_continuous("Year", 
                         breaks = seq(1990, 2018, 5),
                         labels = c("1990", "1995", "2000", "2005", "2010", "2015"))+
      ylim(0,1)+
      ylab('Proportion DR')+
      theme_bw()+
      theme(legend.position = "bottom")+
      ggtitle(unique(subset$COUNTRY_ID))+      
      facet_wrap(~adj_id, nrow = ceiling(sqrt(length(unique(subset$adj_id)))))+
      theme(axis.text.x = element_text(angle = 90, hjust = 1))+
      theme(plot.title = element_text(hjust = 0.5))
  )
}
dev.off()

# Plot map ####
admin0 <- st_read('c:/Users/annieb/Desktop/admin2013_0.shp')
typhi <- st_read('Z:/AMR/Shapefiles/typhi_endemic_admin1.shp')
names(typhi) <- c("COUNTRY_ID", "NAME", "GAUL_CODE", "ADMN_LEVEL",  "PARENT_ID",  "spr_rg_id", 
                  "adj_id","adj_sSA", "adj_id_Asia",  "geometry")

typhi_pred <- merge(typhi, posterior.df, by = c('COUNTRY_ID', 'adj_id'))

background <- admin0[!(admin0$COUNTRY_ID %in% typhi_pred$COUNTRY_ID),]
  
  
png(paste0('model_results/bugs/admin1/', model_name, '/5_yr_map.png'),
    height = 30, width = 20, units = 'cm', res = 300)
ggplot()+
  geom_sf(data = background, fill = '#bdbdbd',colour = 'black', size = 0.15)+
  geom_sf(data = typhi_pred[typhi_pred$year == 1990 |
                              typhi_pred$year == 1995 |
                              typhi_pred$year == 2000 |
                              typhi_pred$year == 2005 |
                              typhi_pred$year == 2010 |
                              typhi_pred$year == 2015,], aes(fill = p.mean),colour = NA)+
  geom_sf(data = admin0, fill = NA, colour = 'black', size = 0.15)+
  theme_bw()+
  theme(line = element_blank(),
        axis.text = element_blank())+
  scale_fill_viridis(option='inferno', discrete = F, direction = -1, limits = c(0, 1))+
  labs(fill = 'Proportion MDR')+
  facet_wrap(~year, ncol = 2)+
  xlim(-20,150)+
  ylim(-35,55)
dev.off()
