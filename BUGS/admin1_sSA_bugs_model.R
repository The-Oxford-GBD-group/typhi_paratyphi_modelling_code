#### SETUP ####
rm(list = ls())
library(R2WinBUGS)
library(sp)
library(spdep)
library(rgdal)
library(coda)
library(data.table)
library(foreign)
library(tidyverse)
library(plyr)
RMSE = function(m, o){
  sqrt(mean((m - o)^2))
}
setwd("Z:/AMR/Pathogens/typhi_paratyphi")
model_name <- '1_initial_run' 
dir.create(paste0('model_results/bugs/admin1/', model_name), showWarnings = F, recursive = T)

##Define the model in BUGS language ####
sink("typhi.bug")
cat("
MODEL 
{ 

    for(i in 1:482){
      h.2[i]~dnorm(0,tau.h2)
  }

  	for(i in 1:N){
      h.1[i]~dnorm(0,tau.h1)
  }
    for(i in 1:nTot){
      number_resistant[i] ~ dbin(p[i],sample_size[i])
    logit(p[i])<-beta0+cov1[i]+cov2[i]+cov3[i]+w.1[adj_id[i]]+h.1[adj_id[i]]+theta.1[year[i]]+h.2[source_num[i]]+nu.1[adj_id[i],year[i]]  
  }


#- Space
				
w.1[1:N]~car.normal(adj[],weights[],num[],tau.w)

for(k in 1:sumNumNeigh){
				weights[k]<-1
				}
				
# - Time- RW(1)
				
theta.1[1:T] ~ car.normal(adj.t[], weights.t[], num.t[], tau.t)

             for(t in 1:1) {
                weights.t[t] <- 1;
               adj.t[t] <- t+1;
               num.t[t] <- 1
             }
             for(t in 2:(T-1)) {
                weights.t[2+(t-2)*2] <- 1;
              adj.t[2+(t-2)*2] <- t-1
                weights.t[3+(t-2)*2] <- 1;
               adj.t[3+(t-2)*2] <- t+1;
              num.t[t] <- 2
            }
             for(t in T:T) {
                weights.t[(T-2)*2 + 2] <- 1;
               adj.t[(T-2)*2 + 2] <- t-1;
               num.t[t] <- 1
             }

# Space-time Type I interaction
for( i in 1 : N ) {
for( t in 1 : T ) {
nu.1[i,t]~dnorm(0, tau.nu)
}
}

#Hyper priors

tau.h1~dgamma(0.5,0.0005) 
tau.h2~dgamma(0.5,0.0005) 
tau.t ~ dgamma(0.5,0.0005) 
tau.w ~ dgamma(0.5, 0.0005)
tau.nu ~ dgamma(0.5,0.0005)

#Intercepts
beta0~dflat()

#Coefficients

#for(i in 1:5){ 
#	b[i]~dnorm(0,0.0001) 
#}

}
# end model
", fill=TRUE)
sink()

# Setup the data ####
#get the input data
mydata <- fread("Z:/AMR/Pathogens/typhi_paratyphi/model_prep/admin1_ST_CAR/MDR_Typhi.csv")
# mydata <- mydata[mydata$is_outlier == 0,]
mydata <- mydata[,.(adj_id, adj_id_sSA, adj_id_Asia, iso3, year, source_id, 
                    number_resistant = n, sample_size = d, val = p)]

mydata <- mydata[!is.na(mydata$adj_id_sSA),]
# #get the adjID from the shapefile
# locs <- read.dbf('Z:/AMR/Shapefiles/typhi_endemic.dbf')
# locs <- data.frame(locs[c('loc_id', 'adj_id', 'ihme_lc_id', 'region_id')])
# locs$loc_id <- as.numeric(as.character(locs$loc_id))
# locs$adj_id <- as.numeric(as.character(locs$adj_id))
# locs$region_id <- as.numeric(as.character(locs$region_id))

# #merge locs onto data
# mydata <- merge(mydata, locs, by.x = c('location_id'), by.y = c('loc_id'))

#get covs (to have a template for all country-years)
covs <- read.csv("Z:/AMR/Pathogens/typhi_paratyphi/model_results/CAR_INLA/admin1/MDR_Typhi/2021_04_23_sSA/child_model_preds.csv")
# covs$year_id <-  covs$year_id-2
# covs <- merge(covs, locs, by.x = 'location_id', by.y = 'loc_id')
covs <- covs[order(covs$year_id, covs$adj_id),]
covs <- covs[!is.na(covs$adj_id_sSA),]

#add the covariates onto the data
mydata <- merge(covs, mydata)

#add the covs data frame onto the data for predictions
# This will mean the data for fitting is on top and prediction on the bottom
mydata <- rbind.fill(mydata, covs)

#Make year id 1:29
mydata$year <- mydata$year_id-1989

# Get the variables required in the model
number_resistant <-  round(mydata$number_resistant,0)
sample_size <-  mydata$sample_size
adj_id <- mydata$adj_id_sSA
year <- mydata$year
source_num <- as.numeric(as.factor(mydata$source_id))
source_num[is.na(source_num)] <- 482
cov1 <- mydata$xgboost
cov2 <- mydata$gam
cov3 <- mydata$ridge

#fill in the missing values (made it work with the aggregated file)
sample_size[is.na(sample_size)] <- 50

#set up adjacency matrix info
#Number of neighbours
num<-c(5,4,7,3,5,6,3,4,6,4,1,5,5,7,6,3,6,3,5,2,6,6,5,5,8,5,6,4,4,5,
       6,4,6,5,5,7,6,5,6,9,5,5,2,3,6,4,6,7,5,3,6,5,8,6,7,4,6,6,7,7,
       8,4,5,7,5,5,5,5,4,5,8,6,8,7,5,4,2,7,5,6,5,8,6,2,3,5,7,5,6,7,
       6,9,5,7,8,4,6,4,5,8,6,9,8,14,5,5,14,3,5,11,17,11,4,6,4,3,5,5,
       9,6,6,8,0,0,0,4,5,3,2,4,3,0,4,4,4,4,6,1,8,4,3,2,4,1,6,5,11,17,
       5,7,6,6,4,7,5,4,8,4,7,4,5,3,9,6,5,7,4,7,1,6,6,5,6,4,10,1,7,2,5,
       4,3,4,5,3,1,4,4,6,3,2,4,0,1,1,6,4,3,3,3,5,8,3,5,4,16,9,2,4,8,6,
       4,4,6,3,4,3,3,4,7,4,5,5,6,6,5,4,2,4,6,4,5,6,3,6,2,5,4,3,4,5,3,6,
       7,4,1,5,9,4,7,5,6,8,8,3,5,3,5,2,1,3,8,4,10,5,4,8,6,6,2,5,5,6,5,3,
       1,6,2,6,5,6,6,8,6,8,5,6,1,7,7,6,6,3,7,7,6,5,5,4,4,3,5,8,4,6,5,10,
       7,2,8,7,5,4,9,6,7,7,2,4,4,5,5,6,6,4,6,5,6,8,3,7,8,5,4,4,9,6,9,7,1,
       4,3,4,5,5,6,5,6,7,4,2,4,5,3,4,2,4,6,5,3,6,4,4,3,4,4,5,4,4,5,4,8,11,
       7,2,5,5,6,5,0,0,6,8,5,5,6,4,6,7,2,3,6,5,7,5,5,6,5,4,6,6,7,4,4,3,6,4,
       7,5,6,5,4,6,6,7,1,5,6,11,10,5,4,6,10,7,7,4,3,1,2,4,5,6,7,7,1,2,5,5,2,
       4,5,7,7,4,7,5,5,4,5,5,5,5,8,4,5,6,4,2,5,6,3,6,8,5,6,4,6,7,6,8,5,7,6,
       5,5,5,4,7,6,6,7,5,5,3,6,5,5,5,8,5,5,6,6,4,5,5,5,6,4,6,4,6,7,5,5,7,6,
       9,8,7,4,4,4,6,5,6,9,5,7,4,5,8,7,6,7,2,7,4,8,8,7,7,7,5,6,6,6,5,5,5,6,
       6,8,4,5,8,6,7,7,7,6,9,3,6,3,6,5,7,5,5,2,3,5,5,7,5,4,5,5,7
)

sumNumNeigh<-sum(num)

#specify data and adjacency matrix
bugs.data <- list(N=570,T=29,nTot=length(mydata$number_resistant),
                  number_resistant=number_resistant,sample_size=sample_size,
                  adj_id = adj_id, year = year, source_num = source_num,
                  cov1 = cov1, cov2 = cov2, cov3 = cov3,
                  num=num,sumNumNeigh=sumNumNeigh,
                  adj=c(
                    6,10,11,17,18,
                    6,8,9,16,
                    5,6,8,9,13,14,15,
                    103,116,119,
                    3,7,9,15,560,
                    1,2,3,8,10,14,
                    5,9,16,
                    2,3,6,9,
                    2,3,5,7,8,16,
                    1,6,14,17,
                    1,
                    13,14,102,105,107,
                    3,12,14,15,107,
                    3,6,10,12,13,17,102,
                    3,5,13,107,557,560,
                    2,7,9,
                    1,10,14,18,102,103,
                    1,17,103,
                    21,24,27,30,112,
                    21,112,
                    19,20,22,30,32,112,
                    21,25,29,32,34,112,
                    26,31,35,418,419,
                    19,27,112,331,332,
                    22,26,27,30,32,33,34,35,
                    23,25,31,33,35,
                    19,24,25,30,33,331,
                    31,33,328,331,
                    22,34,112,419,
                    19,21,25,27,32,
                    23,26,28,33,328,418,
                    21,22,25,30,
                    25,26,27,28,31,331,
                    22,25,29,35,419,
                    23,25,26,34,419,
                    37,39,55,285,289,305,309,
                    36,39,42,55,410,413,
                    41,43,44,45,47,
                    36,37,40,42,307,309,
                    39,42,46,47,307,310,312,409,412,
                    38,44,47,411,412,
                    37,39,40,409,410,
                    38,45,
                    38,41,411,
                    38,43,46,47,308,310,
                    40,45,47,310,
                    38,40,41,45,46,412,
                    53,56,57,60,250,251,252,
                    56,60,80,82,252,
                    53,54,58,
                    52,54,55,58,164,413,
                    51,55,57,58,59,
                    48,50,54,57,58,60,164,165,
                    50,51,53,58,164,165,
                    36,37,51,52,59,289,413,
                    48,49,60,252,
                    48,52,53,58,59,250,
                    50,51,52,53,54,57,
                    52,55,57,246,250,253,289,
                    48,49,53,56,82,163,165,
                    64,69,72,73,76,385,401,402,
                    64,68,72,104,
                    64,68,111,376,377,
                    61,62,63,68,72,76,376,
                    69,71,72,73,104,
                    67,71,75,104,118,
                    66,70,71,75,94,
                    62,63,64,104,111,
                    61,65,72,73,
                    67,71,74,92,94,
                    65,66,67,70,73,74,77,104,
                    61,62,64,65,69,104,
                    61,65,69,71,74,396,401,403,
                    70,71,73,92,97,396,397,
                    66,67,94,118,122,
                    61,64,385,406,
                    71,104,
                    86,88,89,90,213,217,221,
                    80,91,171,175,252,
                    49,79,81,82,91,252,
                    80,82,87,90,91,
                    49,60,80,81,83,87,159,163,
                    82,84,87,88,159,167,
                    83,88,
                    86,87,90,
                    78,85,87,88,90,
                    81,82,83,85,86,88,90,
                    78,83,84,86,87,
                    78,90,91,175,213,219,
                    78,81,85,86,87,89,91,
                    79,80,81,89,90,175,
                    70,74,93,94,97,98,99,291,313,
                    92,94,96,99,100,
                    67,70,75,92,93,100,122,
                    97,291,295,383,393,398,399,400,
                    93,99,100,101,
                    74,92,95,291,397,400,
                    92,99,101,313,
                    92,93,96,98,101,
                    93,94,96,122,157,195,196,197,
                    96,98,99,294,296,313,
                    12,14,17,103,104,105,108,120,121,
                    4,17,18,102,108,113,119,121,
                    62,65,66,68,71,72,77,102,105,106,111,114,118,120,
                    12,102,104,106,107,
                    104,105,107,109,111,
                    12,13,15,105,106,109,112,419,431,552,553,555,557,558,
                    102,103,121,
                    106,107,110,111,112,
                    109,111,112,330,332,451,481,518,520,528,532,
                    63,68,104,106,109,110,371,377,450,451,473,476,477,484,489,514,544,
                    19,20,21,22,24,29,107,109,110,332,419,
                    103,117,119,121,
                    104,115,118,120,122,150,
                    114,122,150,154,
                    4,119,153,
                    113,119,120,121,150,
                    66,75,104,114,122,
                    4,103,113,116,117,150,152,153,155,
                    102,104,114,117,121,150,
                    102,103,108,113,117,120,
                    75,94,100,114,115,118,154,157,
                    
                    
                    
                    127,128,148,351,
                    126,128,130,139,148,
                    126,127,351,
                    130,134,
                    127,129,134,139,
                    135,136,137,
                    
                    135,136,137,146,
                    129,130,137,139,
                    131,133,136,146,
                    131,133,135,137,
                    131,133,134,136,139,146,
                    147,
                    127,130,134,137,140,146,147,148,
                    139,141,146,147,
                    140,147,378,
                    147,148,
                    145,147,373,378,
                    147,
                    143,147,201,205,372,373,
                    133,135,137,139,140,
                    138,139,140,141,142,143,144,145,148,201,378,
                    126,127,139,142,147,201,203,351,352,356,357,358,363,364,366,367,368,
                    151,156,157,195,197,
                    114,115,117,119,120,154,155,
                    149,152,154,155,156,157,
                    119,151,153,154,155,156,
                    116,119,152,156,
                    115,122,150,151,152,155,157,
                    119,150,151,152,154,
                    149,151,152,153,
                    100,122,149,151,154,195,196,198,
                    159,160,161,167,
                    82,83,158,161,163,166,167,
                    158,161,162,167,
                    158,159,160,162,166,
                    160,161,166,
                    60,82,159,164,165,166,409,410,413,
                    51,53,54,163,165,413,
                    53,54,60,163,164,
                    159,161,162,163,409,411,412,
                    83,158,159,160,
                    172,173,187,191,334,335,337,
                    172,
                    171,173,174,175,247,348,
                    79,170,175,247,249,252,
                    168,169,173,174,348,
                    168,170,172,174,247,334,
                    170,172,173,348,
                    79,89,91,170,171,209,215,219,347,348,
                    178,
                    179,180,181,333,335,337,338,
                    176,182,
                    177,180,182,335,336,
                    177,179,333,343,
                    177,335,337,
                    178,179,336,341,
                    187,188,189,191,335,
                    186,188,190,
                    189,
                    184,188,336,341,
                    168,183,191,335,
                    183,184,186,190,335,336,
                    183,185,191,
                    184,188,
                    168,183,187,189,
                    
                    194,
                    193,
                    100,149,157,196,197,198,
                    100,157,195,198,
                    100,149,195,
                    157,195,196,
                    201,202,205,
                    201,203,205,420,438,
                    145,147,148,199,200,202,203,205,
                    199,201,205,
                    148,200,201,357,359,
                    205,206,423,507,
                    145,199,200,201,202,204,206,207,372,414,420,423,441,448,469,540,
                    204,205,448,463,466,490,507,513,551,
                    205,372,
                    209,210,212,218,
                    175,208,210,211,215,216,218,219,
                    208,209,212,215,218,347,
                    209,216,219,220,
                    208,210,347,349,
                    78,89,219,220,221,222,
                    217,221,222,
                    175,209,210,347,
                    209,211,218,
                    78,214,221,
                    208,209,210,216,
                    89,175,209,211,213,220,222,
                    211,213,219,222,
                    78,213,214,217,222,
                    213,214,219,220,221,
                    225,226,231,232,242,243,
                    229,231,236,240,243,244,
                    223,232,234,238,243,
                    223,231,241,242,
                    228,229,
                    227,229,230,237,
                    224,227,228,236,237,240,
                    228,236,237,244,
                    223,224,226,243,244,
                    223,225,233,234,239,242,
                    232,239,242,
                    225,232,238,239,240,243,
                    241,242,
                    224,229,230,237,244,
                    228,229,230,236,
                    225,234,243,
                    232,233,234,240,
                    224,229,234,239,243,
                    226,235,242,
                    223,226,232,233,235,241,
                    223,224,225,231,234,238,240,
                    224,230,231,236,
                    249,
                    59,248,253,288,289,
                    170,171,173,249,267,271,273,334,337,
                    246,253,283,288,
                    171,245,247,251,252,272,273,
                    48,57,59,251,253,
                    48,249,250,252,253,272,
                    48,49,56,79,80,171,249,251,
                    59,246,248,250,251,266,272,277,
                    260,261,426,
                    256,257,258,563,566,
                    255,257,262,
                    255,256,262,263,563,
                    255,259,
                    258,
                    254,261,264,
                    254,260,264,265,281,282,426,432,
                    256,257,263,264,
                    257,262,264,279,281,554,556,563,564,570,
                    260,261,262,263,281,
                    261,280,281,282,
                    253,268,269,272,274,276,277,278,
                    247,268,270,271,273,276,
                    266,267,270,276,278,346,
                    266,274,
                    267,268,271,345,346,
                    247,267,270,337,345,
                    249,251,253,266,273,276,
                    247,249,267,272,276,
                    266,269,278,
                    278,
                    266,267,268,272,273,278,
                    253,266,
                    266,268,274,275,276,346,
                    263,280,281,282,554,
                    265,279,282,424,554,558,
                    261,263,264,265,279,282,
                    261,265,279,280,281,417,424,432,
                    248,284,286,288,290,390,
                    283,290,295,314,383,388,390,395,
                    36,288,289,305,326,
                    283,288,290,304,326,327,
                    289,
                    246,248,283,285,286,289,326,
                    36,55,59,246,285,287,288,
                    283,284,286,301,304,314,
                    92,95,97,295,313,321,
                    296,315,325,
                    297,298,300,306,315,320,325,
                    101,296,306,313,318,320,322,
                    95,284,291,314,321,383,
                    101,292,294,315,318,
                    293,298,317,323,325,
                    293,297,306,323,
                    302,306,309,322,
                    293,315,325,
                    290,303,304,314,316,
                    299,303,304,309,316,322,324,327,
                    301,302,304,316,
                    286,290,301,302,303,327,
                    36,285,309,326,327,
                    293,294,298,299,307,309,319,320,322,323,
                    39,40,306,309,311,312,319,
                    45,310,
                    36,39,299,302,305,306,307,327,
                    40,45,46,308,311,312,323,
                    307,310,312,319,323,
                    40,307,310,311,
                    92,98,101,291,294,316,321,322,324,
                    284,290,295,301,316,321,
                    292,293,296,300,318,320,325,
                    301,302,303,313,314,321,324,
                    297,325,
                    294,296,315,320,
                    306,307,311,323,
                    293,294,306,315,318,
                    291,295,313,314,316,
                    294,299,302,306,313,324,
                    297,298,306,310,311,319,
                    302,313,316,322,
                    292,293,297,300,315,317,
                    285,286,288,305,327,
                    286,302,304,305,309,326,
                    28,31,329,330,331,418,516,522,
                    328,330,331,
                    110,328,329,331,332,516,520,
                    24,27,28,33,328,329,330,332,
                    24,110,112,330,331,
                    177,180,338,343,
                    168,173,247,337,
                    168,177,179,181,183,187,188,336,337,
                    179,182,186,188,335,341,
                    168,177,181,247,271,334,335,338,345,
                    177,333,337,342,343,344,345,
                    340,
                    339,342,343,344,
                    182,186,336,
                    338,340,343,344,
                    180,333,338,340,342,
                    338,340,342,345,346,
                    270,271,337,338,344,346,
                    268,270,278,344,345,
                    175,210,212,215,348,349,
                    170,172,174,175,347,349,350,
                    212,347,348,350,
                    348,349,
                    126,128,148,368,
                    148,354,357,358,360,
                    364,365,366,
                    352,357,360,361,
                    360,362,
                    148,358,362,363,
                    148,203,352,354,359,361,
                    148,352,356,360,362,
                    203,357,361,
                    352,354,355,358,361,362,
                    354,357,359,360,
                    355,356,358,360,
                    148,356,364,
                    148,353,363,366,
                    353,366,367,368,
                    148,353,364,365,367,
                    148,365,366,368,
                    148,351,365,367,
                    370,371,373,375,377,
                    369,373,375,378,
                    111,369,372,373,377,521,534,544,
                    145,205,207,371,373,442,460,464,512,521,540,
                    143,145,369,370,371,372,378,
                    375,376,
                    369,370,374,376,377,
                    63,64,374,375,377,
                    63,111,369,371,375,376,
                    141,143,147,370,373,
                    
                    
                    386,387,388,389,404,405,
                    385,386,387,391,392,401,402,405,
                    95,284,295,393,395,
                    396,397,400,407,408,
                    61,76,382,402,405,406,
                    381,382,387,405,
                    381,382,386,388,392,394,
                    284,381,387,389,390,394,395,
                    381,388,
                    283,284,388,
                    382,392,393,399,401,407,
                    382,387,391,393,394,
                    95,383,391,392,394,395,399,
                    387,388,392,393,395,
                    284,383,388,393,394,
                    73,74,384,397,403,407,
                    74,97,384,396,400,
                    95,399,400,408,
                    95,391,393,398,407,408,
                    95,97,384,397,398,408,
                    61,73,382,391,402,403,407,
                    61,382,385,401,
                    73,396,401,407,
                    381,405,406,
                    381,382,385,386,404,406,
                    76,385,404,405,
                    384,391,396,399,401,403,408,
                    384,398,399,400,407,
                    40,42,163,166,410,412,
                    37,42,163,409,413,
                    41,44,166,412,
                    40,41,47,166,409,411,
                    37,51,55,163,164,410,
                    205,416,420,422,423,433,434,
                    430,
                    414,417,422,425,434,
                    282,416,424,425,432,434,
                    23,31,328,419,423,427,433,510,517,522,539,
                    23,29,34,35,107,112,418,431,433,437,
                    200,205,414,422,438,
                    425,426,430,432,
                    414,416,420,425,434,438,
                    204,205,414,418,427,433,491,507,517,530,
                    280,282,417,431,434,437,558,
                    416,417,421,422,430,432,438,
                    254,261,421,432,
                    418,423,433,
                    435,
                    436,439,
                    415,421,425,438,
                    107,419,424,437,558,
                    261,282,417,421,425,426,
                    414,418,419,423,427,434,437,
                    414,416,417,422,424,433,437,
                    428,
                    429,439,
                    419,424,431,433,434,
                    200,420,422,425,430,
                    429,436,
                    462,472,478,487,
                    205,448,463,469,470,
                    372,464,473,489,493,503,512,
                    461,479,486,496,509,531,535,
                    495,508,537,546,
                    455,471,507,513,530,537,551,
                    491,506,515,529,530,
                    456,467,492,505,523,
                    205,206,441,463,
                    458,463,470,482,485,
                    111,468,473,503,514,
                    110,111,476,518,524,
                    459,475,481,499,532,
                    457,465,504,508,525,529,535,541,
                    456,492,502,548,
                    445,465,471,530,541,
                    447,454,467,492,502,517,
                    453,465,515,529,
                    449,463,
                    452,475,499,522,547,
                    372,462,464,480,487,540,
                    443,479,509,
                    440,460,469,472,487,540,
                    206,441,448,449,458,470,482,490,
                    372,442,460,480,493,
                    453,455,457,515,530,541,
                    206,490,546,551,
                    447,456,502,505,510,517,
                    450,496,498,503,514,531,550,
                    205,441,462,470,472,540,
                    441,449,463,469,472,485,497,542,
                    445,455,495,537,541,
                    440,462,469,470,478,536,542,
                    111,442,450,484,489,503,
                    483,497,504,508,542,
                    452,459,481,538,547,
                    111,451,514,519,524,
                    111,489,534,544,
                    440,472,480,487,488,509,536,
                    443,461,493,496,503,509,
                    460,464,478,487,493,509,
                    110,452,475,518,527,532,538,
                    449,463,485,490,546,
                    474,504,525,536,542,
                    111,473,489,
                    449,470,482,497,508,546,
                    443,488,509,525,535,
                    440,460,462,478,480,
                    478,486,509,525,536,
                    111,442,473,477,484,512,521,534,
                    206,463,466,482,546,
                    423,446,506,517,530,
                    447,454,456,523,548,549,
                    442,464,479,480,503,509,
                    498,548,549,550,
                    444,471,508,537,541,
                    443,468,479,503,531,
                    470,474,485,508,542,
                    468,494,514,519,549,550,
                    452,459,522,532,
                    501,519,523,527,543,549,
                    500,519,524,527,
                    454,456,467,517,533,548,
                    442,450,468,473,479,493,496,
                    453,474,483,508,525,
                    447,467,510,511,523,
                    446,491,517,526,529,533,545,
                    204,206,423,445,513,530,
                    444,453,474,485,495,497,504,541,546,
                    443,461,478,479,480,486,488,493,
                    418,467,505,511,517,539,543,
                    505,510,523,543,
                    372,442,489,521,
                    206,445,507,551,
                    111,450,468,476,498,519,
                    446,457,465,529,530,
                    328,330,520,522,528,532,
                    418,423,456,467,491,502,506,510,533,
                    110,451,481,524,527,
                    476,498,500,501,514,524,549,
                    110,330,516,528,
                    371,372,489,512,534,
                    328,418,459,499,516,532,539,547,
                    447,492,500,505,511,543,549,
                    451,476,501,518,519,527,
                    453,483,486,488,504,535,536,
                    506,533,
                    481,500,501,518,524,538,543,
                    110,516,520,532,
                    446,453,457,506,515,531,535,545,
                    423,445,446,455,465,491,507,515,
                    443,468,496,529,535,545,550,
                    110,452,481,499,516,522,528,
                    502,506,517,526,545,548,550,
                    371,477,489,521,544,
                    443,453,486,525,529,531,
                    472,478,483,488,525,542,
                    444,445,471,495,546,551,
                    475,481,527,543,547,
                    418,510,522,543,547,
                    205,372,460,462,469,
                    453,455,465,471,495,508,
                    470,472,474,483,497,536,
                    500,510,511,523,527,538,539,547,
                    111,371,477,534,
                    506,529,531,533,550,
                    444,466,482,485,490,508,537,551,
                    459,475,522,538,539,543,
                    454,492,494,502,533,549,550,
                    492,494,498,500,519,523,548,
                    468,494,498,531,533,545,548,
                    206,445,466,513,537,546,
                    107,553,554,555,556,557,558,559,560,
                    107,552,557,
                    263,279,280,552,556,558,
                    107,552,558,
                    263,552,554,559,564,565,
                    15,107,552,553,560,
                    107,280,424,431,552,554,555,
                    552,556,560,565,569,
                    5,15,552,557,559,
                    567,569,
                    564,565,570,
                    255,257,263,566,570,
                    263,556,562,565,570,
                    556,559,562,564,568,569,570,
                    255,563,567,568,570,
                    561,566,568,569,
                    565,566,567,569,570,
                    559,561,565,567,568,
                    263,562,563,564,565,566,568))

##Load initial values

inits <- function(){
  list(beta0=rnorm(1), tau.h1=runif(1,0,2),tau.h2=runif(1,0,2), tau.t=runif(1,0,2), tau.w=runif(1,0,2), tau.nu=runif(1,0,2))
}

inits()

#Paramters to estimate and keep track of
parameters <- c("beta0","tau.h1","tau.h2","tau.t","tau.w","tau.nu","p")

# MCMC settings
nchains <- 1
niter <- 10000
nburnin <- 5000
nthin <- 1

##Locate WinBUGS by setting path below specifically for the computer used.
bugs.dir<-"C:/Users/annieb/Documents/WinBUGS14"

# Do the MCMC stuff from R
out <- bugs(data = bugs.data, inits = inits, parameters.to.save = parameters, model.file = "typhi.bug", n.chains = nchains, n.thin=nthin, n.iter=niter, n.burnin=nburnin, debug=TRUE, bugs.directory=bugs.dir)
summary(out)

my_log <- file("my_log.txt")
sink(my_log, append = TRUE, type = "output")
print(out, 3)
closeAllConnections() 

#get the model predictions

start <- length(mydata$number_resistant[!is.na(mydata$number_resistant)])+length(parameters)
end <- length(out$summary[,1])-1
posterior.df <- data.frame(p.mean = out$summary[start:end,1], 
                           p.sd = out$summary[start:end,2],
                           p.lower=out$summary[start:end,3], 
                           p.upper=out$summary[start:end,7],
                           adj_id = adj_id[is.na(number_resistant)],
                           year_id = year[is.na(number_resistant)]+1989)

posterior.df <-  merge(posterior.df, locs, by = 'adj_id')

write.csv(posterior.df,paste0("model_results/bugs/", model_name, "/bugs_final.csv"), row.names=F)

#check in sample stats #### 
results <- mydata[!is.na(mydata$number_resistant),]
results <- merge(results, posterior.df, all.y = T)
coverage <- results$val[!is.na(results$val)]>results$p.lower[!is.na(results$val)] & results$val[!is.na(results$val)]<results$p.upper[!is.na(results$val)]


model_metrics <- data.frame(r2 = cor(results$val[!is.na(results$val)], results$p.mean[!is.na(results$val)])^2,
                            RMSE = RMSE(results$val[!is.na(results$val)], results$p.mean[!is.na(results$val)]),
                            coverage = length(coverage[coverage==TRUE])/length(coverage)*100)

write.csv(model_metrics, paste0('model_results/bugs/', model_name, '/model_metrics.csv'), row.names = F)

#Plot out model estimates ####
results$region_id <- as.character(results$region_id)
results$ihme_lc_id <- as.character(results$ihme_lc_id)
results <- results[!is.na(results$region_id),]

pdf(paste0('model_results/bugs/', model_name, '/estimates.pdf'),
    height = 8.3, width = 11.7)

#plot out a page for each region
for(i in 1:length(unique(results$region_id))){
  subset <- results[results$region_id == unique(results$region_id)[i],]
  print(
    ggplot(subset)+
      geom_line(aes(x=year_id, y = p.mean),color = 'green')+
      geom_ribbon(aes(ymin = p.lower, ymax=p.upper, x = year_id), alpha = 0.1, fill = 'green') +
      geom_point(aes(x = year_id, y = val))+
      # geom_pointrange(aes(x=year_id, y = val, ymin = lower_ci, ymax = upper_ci)) +
      scale_x_continuous("Year", 
                         breaks = seq(1990, 2018, 5),
                         labels = c("1990", "1995", "2000", "2005", "2010", "2015"))+
      ylim(0,1)+
      ylab('Proportion DR')+
      theme_bw()+
      theme(legend.position = "bottom")+
      ggtitle(unique(subset$region_id))+      
      facet_wrap(~ihme_lc_id, nrow = ceiling(sqrt(length(unique(subset$adj_id)))))+
      theme(axis.text.x = element_text(angle = 90, hjust = 1))+
      theme(plot.title = element_text(hjust = 0.5))
  )
}
dev.off()

